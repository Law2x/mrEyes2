<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Yeloüü°Spot ‚Äî Admin Dashboard</title>
  <style>
    :root{
      --bg:#0f1115;
      --panel:#151922;
      --panel-2:#1b2130;
      --muted:#8892a6;
      --text:#e8edf7;
      --brand:#ffd44d;
      --brand-ink:#1c1600;
      --ok:#35c06d;
      --warn:#ffb020;
      --bad:#ff5d5d;

      /* sizing */
      --container: 840px;                  /* ‚Äúfixed-feel‚Äù max width */
      --header-pad: clamp(8px,2vw,14px);
      --card-radius: 18px;
      --card-pad: 16px;
      --chip-h: 34px;
      --btn-h: 36px;

      /* toggle / refresh shared pill size */
      --pill-h: 38px;
      --pill-pad-x: 14px;
      --pill-radius: 999px;
    }

    * { box-sizing: border-box; }
    html,body{
      margin:0; padding:0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .wrap{
      max-width: var(--container);
      margin: 0 auto;
      padding: 8px 14px 28px;
    }

    /* HEADER */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: var(--header-pad) 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      margin-bottom:12px;
    }
    .brand{
      display:flex; flex-direction:column;
      gap:4px; min-width:0;
    }
    .brand .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size: clamp(22px, 4.8vw, 30px);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .brand .subtitle{
      font-size: 13px;
      color: var(--muted);
    }

    .header-ctrls{
      display:flex; align-items:center; gap:10px;
      flex: 0 0 auto;
    }

    /* pill base (toggle + refresh share size) */
    .pill{
      height: var(--pill-h);
      padding: 0 var(--pill-pad-x);
      border-radius: var(--pill-radius);
      background: var(--panel);
      display:flex; align-items:center; gap:10px;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 4px 14px rgba(0,0,0,.25);
      user-select:none;
    }
    .pill .label{
      font-weight:700; font-size:14px;
    }

    /* toggle */
    .toggle{
      position:relative; width:44px; height:24px;
      background: #2a3142;
      border-radius:999px; cursor:pointer; flex:0 0 auto;
    }
    .toggle .knob{
      position:absolute; top:3px; left:3px;
      width:18px; height:18px; border-radius:50%;
      background:#dfe7f5; transition: all .18s ease;
      box-shadow: 0 1px 0 rgba(0,0,0,.2), 0 3px 8px rgba(0,0,0,.25) inset;
    }
    .toggle.on{ background:#214c33; }
    .toggle.on .knob{ left:23px; background:#35c06d; }

    /* refresh */
    .btn-refresh{
      background: linear-gradient(180deg, #ffd54d, #ffcd1b);
      color: var(--brand-ink);
      font-weight:800;
      border:none; outline:none; cursor:pointer;
      border-radius: var(--pill-radius);
      height: var(--pill-h);
      padding: 0 var(--pill-pad-x);
      display:flex; align-items:center; gap:8px;
      box-shadow: 0 6px 18px rgba(255,205,27,.25);
    }

    /* KPI ROW (always one line) */
    .kpis{
      display:grid; grid-template-columns: 1fr 1fr;
      gap: 12px; margin-top: 14px;
    }
    .card{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--card-radius);
      padding: var(--card-pad);
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      min-width:0;
    }
    .k-card .row{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-bottom: 8px;
    }
    .k-label{ font-size:18px; font-weight:800; }
    .chip{
      height: var(--chip-h); padding:0 12px;
      border-radius: 10px; display:flex; align-items:center; gap:8px;
      background: var(--panel-2); color:#cfd6e6; font-weight:700; font-size:14px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .k-value{
      font-size: clamp(34px, 6.5vw, 44px);
      line-height:1; font-weight:900; letter-spacing:.4px;
      padding-top:6px;
    }

    /* SECTION TITLE */
    .section-title{
      font-size: 22px; font-weight:900; margin: 18px 0 8px;
    }

    /* ORDERS LIST */
    .orders{ display:flex; flex-direction:column; gap:12px; }
    .order{
      background: var(--panel); border:1px solid rgba(255,255,255,0.06);
      border-radius: var(--card-radius); padding:16px; position:relative;
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
    }
    .order-top{
      display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center; justify-content:space-between;
      margin-bottom: 8px;
    }
    .badges{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .badge{
      height:28px; border-radius: 999px; padding:0 12px; display:flex; align-items:center;
      font-weight:800; letter-spacing:.3px; font-size:12px; text-transform:uppercase;
      background:#2b3346; color:#cbd3e6; border:1px solid rgba(255,255,255,.06);
    }
    .badge.ok{ background:#153923; color:#9ee7b9; border-color:#1a5a38; }
    .badge.warn{ background:#3a320f; color:#ffd77c; border-color:#5f4e11; }
    .badge.bad{ background:#3b1717; color:#ff9b9b; border-color:#6a2626; }

    .order-title{
      font-size: 18px; font-weight:900; margin: 2px 0 2px;
      word-break: break-word;
    }
    .order-sub{ color: var(--muted); font-size:14px; margin-bottom:8px; }
    .items{ margin:10px 0 12px; color:#dfe6f9; font-size:15px; }
    .items .dot{ color:#5b6882; }

    .actions{
      display:flex; flex-wrap:wrap; gap:10px;
    }
    .btn{
      height: var(--btn-h);
      padding: 0 14px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.08);
      background:#22293a; color:#dfe6f9; font-weight:800; cursor:pointer;
    }
    .btn.primary{ background:#28324a; }
    .btn.ok{ background:#193e2c; color:#9ee7b9; border-color:#275a41; }
    .btn.bad{ background:#3a1c1c; color:#ffc9c9; border-color:#5a2a2a; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    /* delivered overlay */
    .delivered-mark{
      position:absolute; right:14px; bottom:14px;
      display:flex; align-items:center; gap:8px; color:#a9f0c7;
      font-weight:900;
    }
    .delivered-mark svg{ width:24px; height:24px; }

    /* MODAL (simple) */
    .modal-scrim{
      position:fixed; inset:0; background:rgba(0,0,0,.5); display:none;
      align-items:center; justify-content:center; z-index:10;
    }
    .modal{
      width:min(92vw, 480px); background:#0f1218; border:1px solid rgba(255,255,255,.08);
      border-radius:18px; padding:18px;
      box-shadow: 0 18px 44px rgba(0,0,0,.4);
    }
    .modal h3{ margin:0 0 12px; }
    .modal p{ color:#c3cbe2; }
    .modal .row{ display:flex; gap:10px; margin-top:12px; }
    .field{
      width:100%; height:40px; border-radius:10px; border:1px solid rgba(255,255,255,.1);
      background:#1a2030; color:#e9efff; padding:0 12px; outline:none;
    }

    /* make sure there‚Äôs NO horizontal scroll */
    body { overflow-x:hidden; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="title">Yeloüü°Spot</div>
        <div class="subtitle">Admin Dashboard</div>
      </div>

      <div class="header-ctrls">
        <div id="shopPill" class="pill">
          <div class="label">Shop</div>
          <div id="shopToggle" class="toggle"><div class="knob"></div></div>
        </div>

        <button id="btnRefresh" class="btn-refresh">
          <span>‚ü≥</span> <span>Refresh</span>
        </button>
      </div>
    </div>

    <!-- KPI row -->
    <div class="kpis">
      <!-- Orders -->
      <div class="card k-card" id="ordersCard">
        <div class="row">
          <div class="k-label">Orders</div>
          <select id="ordersFilter" class="chip" aria-label="Orders filter">
            <option value="all">All</option>
            <option value="confirmed">Order confirmed</option>
            <option value="out_for_delivery">Out for delivery</option>
            <option value="completed">Delivered</option>
            <option value="canceled">Canceled</option>
          </select>
        </div>
        <div class="k-value" id="ordersCount">0</div>
      </div>

      <!-- Sales -->
      <div class="card k-card" id="salesCard">
        <div class="row">
          <div class="k-label">Sales</div>
          <select id="salesTimeline" class="chip" aria-label="Sales timeline">
            <option value="today">Today</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
            <option value="all">All time</option>
          </select>
        </div>
        <div class="k-value" id="salesValue">‚Ç±0</div>
      </div>
    </div>

    <div class="section-title">All orders</div>
    <div id="ordersList" class="orders"></div>
  </div>

  <!-- Simple modal -->
  <div id="scrim" class="modal-scrim">
    <div class="modal" id="modalBox">
      <h3 id="modalTitle">Yeloüü°Spot</h3>
      <p id="modalText">Message‚Ä¶</p>
      <input id="modalInput" class="field" placeholder="Paste link‚Ä¶" style="display:none;">
      <div class="row">
        <button id="modalOk" class="btn ok">OK</button>
        <button id="modalCancel" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
/* -------------------- TELEGRAM AUTH -------------------- */
function initTelegram(){
  const tg = window.Telegram && window.Telegram.WebApp;
  if(!tg) return null;
  try { tg.ready(); tg.expand?.(); } catch {}
  return tg;
}
function authHeaders(){
  const h = { "Content-Type": "application/json" };
  const tg = window.Telegram?.WebApp;
  const initData = tg?.initData || (tg?.initDataUnsafe?.query_id ? tg.initData : "");
  if (initData) h["X-Telegram-Init-Data"] = initData;

  // optional dev-secret fallback for testing in a normal browser
  const sp = new URLSearchParams(location.search);
  const devSecret = sp.get("secret") || localStorage.getItem("devSecret");
  if (sp.get("secret")) localStorage.setItem("devSecret", sp.get("secret"));
  if (devSecret) h["X-Dev-Admin-Secret"] = devSecret;

  return h;
}

/* -------------------- UTIL -------------------- */
const fmtPeso = v => "‚Ç±" + (Math.round(v).toLocaleString());
const byStageText = s =>
  s === -1 ? "canceled" :
  s ===  0 ? "confirmed" :
  s ===  1 ? "out_for_delivery" :
  s ===  2 ? "completed" : String(s);

function parseItemAmountToNumber(txt){
  // looks for "‚Ç±" followed by number (with commas)
  const m = (txt || "").match(/‚Ç±\s*([\d,]+)/);
  return m ? Number(m[1].replace(/,/g,"")) : 0;
}
function sumOrderItems(items){
  if(!Array.isArray(items)) return 0;
  return items.reduce((sum,i)=> sum + parseItemAmountToNumber(i.amount || i.label || ""), 0);
}
function formatDateTime(iso){
  try{ return new Date(iso).toLocaleString(); } catch { return iso; }
}

/* -------------------- API -------------------- */
async function apiGet(url){
  const r = await fetch(url, { headers: authHeaders() });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
async function apiPost(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers: authHeaders(),
    body: JSON.stringify(body || {})
  });
  if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

/* -------------------- STATE -------------------- */
let ORDERS = [];
let SHOP_OPEN = true;

/* -------------------- RENDER -------------------- */
const elOrdersCount = document.getElementById("ordersCount");
const elSalesValue  = document.getElementById("salesValue");
const elOrdersList  = document.getElementById("ordersList");
const elOrdersFilter= document.getElementById("ordersFilter");
const elSalesTimeline = document.getElementById("salesTimeline");
const elShopToggle  = document.getElementById("shopToggle");
const elBtnRefresh  = document.getElementById("btnRefresh");

/* modal */
const scrim = document.getElementById("scrim");
const modalText = document.getElementById("modalText");
const modalInput = document.getElementById("modalInput");
const modalOk = document.getElementById("modalOk");
const modalCancel = document.getElementById("modalCancel");
function showAlert(text){
  modalText.textContent = text;
  modalInput.style.display = "none";
  scrim.style.display = "flex";
  modalOk.onclick = ()=> (scrim.style.display="none");
  modalCancel.onclick = ()=> (scrim.style.display="none");
}
function promptLink(title, placeholder, onOk){
  document.getElementById("modalTitle").textContent = "Yeloüü°Spot";
  modalText.textContent = title;
  modalInput.value = "";
  modalInput.placeholder = placeholder || "Paste link‚Ä¶";
  modalInput.style.display = "block";
  scrim.style.display = "flex";
  modalOk.onclick = ()=>{
    const v = modalInput.value.trim();
    if(!v) return;
    scrim.style.display = "none";
    onOk(v);
  };
  modalCancel.onclick = ()=> (scrim.style.display="none");
}

/* toggle UI */
function setToggleUI(on){
  SHOP_OPEN = !!on;
  elShopToggle.classList.toggle("on", !!on);
}

/* cards */
function applyKpi(){
  // Orders count by filter
  const f = elOrdersFilter.value; // all | confirmed | out_for_delivery | completed | canceled
  const filtered = f === "all" ? ORDERS : ORDERS.filter(o => o.status === f || byStageText(o.statusStage) === f);
  elOrdersCount.textContent = String(filtered.length);

  // Sales sum by timeline over COMPLETED only
  const now = Date.now();
  const pick = {
    today:   (d)=> new Date(d).toDateString() === new Date().toDateString(),
    week:    (d)=> (now - new Date(d).getTime()) <= 7*864e5,
    month:   (d)=> (now - new Date(d).getTime()) <= 30*864e5,
    all:     (_)=> true,
  }[elSalesTimeline.value || "today"];

  const sales = ORDERS
    .filter(o => (o.status === "completed" || o.statusStage === 2) && pick(o.createdAt))
    .reduce((sum,o)=> sum + sumOrderItems(o.items), 0);

  elSalesValue.textContent = fmtPeso(sales);
}

function renderOrders(){
  elOrdersList.innerHTML = "";
  const f = elOrdersFilter.value;
  const list = f === "all" ? ORDERS : ORDERS.filter(o => o.status === f || byStageText(o.statusStage) === f);

  if(!list.length){
    const empty = document.createElement("div");
    empty.style.color = "var(--muted)";
    empty.textContent = "‚Äî No orders ‚Äî";
    elOrdersList.appendChild(empty);
    return;
  }

  for(const o of list){
    const card = document.createElement("div");
    card.className = "order";

    const top = document.createElement("div");
    top.className = "order-top";

    const badges = document.createElement("div");
    badges.className = "badges";
    const bId = document.createElement("div");
    bId.className = "badge";
    bId.textContent = `#${o.id}`;
    badges.appendChild(bId);

    const stageText = byStageText(o.statusStage ?? 0);
    const bStage = document.createElement("div");
    bStage.className = "badge " + (stageText === "completed" ? "ok" : stageText === "canceled" ? "bad" : stageText === "out_for_delivery" ? "" : "warn");
    bStage.textContent = stageText.replace(/_/g," ");
    badges.appendChild(bStage);

    const bWhen = document.createElement("div");
    bWhen.className = "badge";
    bWhen.textContent = formatDateTime(o.createdAt);
    badges.appendChild(bWhen);

    top.appendChild(badges);
    card.appendChild(top);

    const ttl = document.createElement("div");
    ttl.className = "order-title";
    ttl.textContent = `${o.name || "Customer"} ‚Ä¢ ${o.phone || "‚Äî"}`;
    card.appendChild(ttl);

    const sub = document.createElement("div");
    sub.className = "order-sub";
    sub.textContent = o.address || "‚Äî";
    card.appendChild(sub);

    const items = document.createElement("div");
    items.className = "items";
    items.innerHTML = (o.items || []).map(i => `‚Ä¢ ${i.category} <span class="dot">‚Äî</span> ${i.amount}`).join("<br>");
    card.appendChild(items);

    const actions = document.createElement("div");
    actions.className = "actions";

    const btnLink = document.createElement("button");
    btnLink.className = "btn primary";
    btnLink.textContent = "Send link";
    btnLink.onclick = ()=>{
      promptLink("Paste the delivery / tracking link", "https://...", async (val)=>{
        try{
          const j = await apiPost(`/api/admin/orders/${o.id}/sendlink`, { link: val });
          if(!j.ok) throw new Error(j.error || "sendlink_failed");
          await refreshAll();
        }catch(e){ showAlert("Failed to send link: " + e.message); }
      });
    };

    const btnDelivered = document.createElement("button");
    btnDelivered.className = "btn ok";
    btnDelivered.textContent = "Delivered";
    btnDelivered.onclick = async ()=>{
      try{
        const j = await apiPost(`/api/admin/orders/${o.id}/stage`, { stage: 2 });
        if(!j.ok) throw new Error(j.error || "update_failed");
        await refreshAll();
      }catch(e){ showAlert("Failed to update: " + e.message); }
    };

    const btnCancel = document.createElement("button");
    btnCancel.className = "btn bad";
    btnCancel.textContent = "Cancel";
    btnCancel.onclick = ()=>{
      promptLink("Type CONFIRM to cancel this order", "CONFIRM", async (val)=>{
        if(val !== "CONFIRM") return;
        try{
          const j = await apiPost(`/api/admin/orders/${o.id}/stage`, { stage: -1 });
          if(!j.ok) throw new Error(j.error || "cancel_failed");
          await refreshAll();
        }catch(e){ showAlert("Failed to cancel: " + e.message); }
      });
    };

    actions.appendChild(btnLink);
    actions.appendChild(btnDelivered);
    actions.appendChild(btnCancel);
    card.appendChild(actions);

    // delivered visuals
    const isDone = (o.status === "completed") || (o.statusStage === 2);
    if(isDone){
      btnLink.disabled = btnDelivered.disabled = btnCancel.disabled = true;
      const mark = document.createElement("div");
      mark.className = "delivered-mark";
      mark.innerHTML = `<svg viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="#9ee7b9" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Delivered</span>`;
      card.appendChild(mark);
    }

    elOrdersList.appendChild(card);
  }
}

/* -------------------- LOAD / REFRESH -------------------- */
async function loadShop(){
  const j = await apiGet("/api/admin/shop");
  if(!j.ok) throw new Error(j.error || "shop_failed");
  setToggleUI(!!j.open);
}
async function setShop(open){
  const j = await apiPost("/api/admin/shop", { open: !!open });
  if(!j.ok) throw new Error(j.error || "shop_set_failed");
  setToggleUI(!!j.open);
}
async function loadOrders(){
  const j = await apiGet("/api/admin/orders");
  if(!j.ok) throw new Error(j.error || "db_error");
  ORDERS = j.orders || [];
}

async function refreshAll(){
  await Promise.all([loadShop(), loadOrders()]);
  applyKpi();
  renderOrders();
}

/* -------------------- EVENTS -------------------- */
elBtnRefresh.addEventListener("click", ()=> refreshAll().catch(e => showAlert("Refresh failed: " + e.message)));
elShopToggle.addEventListener("click", async ()=>{
  try{ await setShop(!SHOP_OPEN); }catch(e){ showAlert("Toggle failed: " + e.message); }
});
elOrdersFilter.addEventListener("change", ()=> applyKpi() || renderOrders());
elSalesTimeline.addEventListener("change", ()=> applyKpi());

/* -------------------- BOOT -------------------- */
(function boot(){
  initTelegram();
  refreshAll().catch(e => showAlert("Failed to load orders: " + (e.message || e)));
})();
</script>
</body>
</html>
