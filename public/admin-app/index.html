<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YeloðŸŸ¡Spot â€” Admin Dashboard</title>
<style>
  :root{--bg:#0b0d10;--card:#14181d;--muted:#8e9aa7;--text:#eaeff5;--accent:#ffd54a;--ok:#27c281;--warn:#ffb020;--bad:#ff6b6b;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.45 ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
  .wrap{max-width:920px;margin:0 auto;padding:18px}
  .top{display:flex;align-items:center;gap:12px}
  .brand{font-weight:800;letter-spacing:.2px}
  .brand .dot{color:var(--accent)}
  .spacer{flex:1}
  .toolbar{display:flex;align-items:center;gap:10px}
  .pill{display:inline-flex;align-items:center;gap:10px;background:var(--card);padding:8px 12px;border-radius:999px}
  .switch{position:relative;display:inline-flex;align-items:center;gap:10px}
  .switch input{appearance:none;width:46px;height:26px;background:#2a3139;border-radius:999px;position:relative;outline:none;cursor:pointer;transition:.2s}
  .switch input:checked{background:#2d7a4b}
  .switch input::after{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.2s}
  .switch input:checked::after{transform:translateX(20px)}
  .btn{background:var(--accent);color:#1b1b1b;border:0;padding:9px 14px;border-radius:14px;font-weight:800;cursor:pointer}
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin:14px 0}
  @media (max-width:640px){.cards{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:18px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .card h3{margin:0 0 10px 0;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:10px}
  select{appearance:none;background:#0f1317;border:1px solid #242a31;color:var(--text);padding:8px 12px;border-radius:10px}
  .kpi{display:flex;align-items:center;gap:10px}
  .num{font-size:32px;font-weight:900}
  .peso{font-size:26px;font-weight:900}
  .chip{margin-left:auto;background:#0f1317;border:1px solid #242a31;padding:4px 8px;border-radius:10px;color:var(--muted);font-weight:700}
  .list-title{margin:8px 2px 10px;color:var(--muted)}
  .order{background:#101419;border:1px solid #1d232a;border-radius:16px;padding:12px;margin-bottom:10px}
  .order .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .order .id{font-weight:900}
  .order .when{color:var(--muted)}
  .tags{display:flex;gap:8px;margin:6px 0}
  .tag{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
  .t-ok{background:#133a26;color:#9ae6b4;border:1px solid #1e6a40}
  .t-warn{background:#3a300f;color:#ffe29a;border:1px solid #6a541e}
  .t-bad{background:#3a1717;color:#ffc1c1;border:1px solid #6a2d2d}
  .row-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .btn-ghost{background:#0f1317;border:1px solid #242a31;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
  .sel{min-width:170px}
  .empty{color:var(--muted);margin:14px 2px}
  .toast{position:fixed;inset:auto 16px 16px auto;background:#131722;border:1px solid #253048;color:var(--text);padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Top bar -->
  <div class="top">
    <div class="brand">Yelo<span class="dot">ðŸŸ¡</span>Spot <span style="color:var(--muted)">â€” Admin Dashboard</span></div>
    <div class="spacer"></div>

    <!-- Shop toggle now beside/above Refresh in the toolbar -->
    <div class="toolbar">
      <div class="pill">
        <strong>Shop</strong>
        <label class="switch"><input id="shopToggle" type="checkbox" /><span></span></label>
      </div>
      <button id="btnRefresh" class="btn">âŸ³ Refresh</button>
    </div>
  </div>

  <!-- KPI cards -->
  <div class="cards">
    <div class="card">
      <h3>Orders
        <select id="orderFilter" class="sel">
          <option value="all">All</option>
          <option value="confirmed">Order Confirmed</option>
          <option value="out_for_delivery">Out for Delivery</option>
          <option value="completed">Delivered</option>
          <option value="canceled">Canceled</option>
        </select>
        <span id="orderCount" class="chip">0</span>
      </h3>
      <div class="kpi"><span class="num" id="ordersNum">0</span></div>
    </div>

    <div class="card">
      <h3>Sales
        <select id="salesFilter" class="sel">
          <option value="all">All</option>
          <option value="today">Today</option>
          <option value="week">This week</option>
          <option value="month">This month</option>
        </select>
      </h3>
      <div class="kpi"><span class="peso">â‚±</span><span class="num" id="salesNum">0</span></div>
    </div>
  </div>

  <div class="list-title" id="listTitle">All orders</div>
  <div id="ordersList"></div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script>
  // ---------- Telegram initData helper ----------
  function getInitData() {
    const tg = window.Telegram?.WebApp;
    if (tg?.initData && tg.initData.length) return tg.initData;
    // Fallbacks: some platforms stash it in URL
    const hash = new URLSearchParams(location.hash.slice(1));
    const viaHash = hash.get('tgWebAppData');
    if (viaHash) return viaHash;
    const qs = new URLSearchParams(location.search);
    return qs.get('initData') || '';
  }

  async function api(path, opt = {}) {
    const initData = getInitData();
    const headers = Object.assign(
      { 'Content-Type': 'application/json', 'X-Telegram-Init-Data': initData },
      opt.headers || {}
    );
    const res = await fetch(path, Object.assign({}, opt, { headers }));
    let body = null;
    try { body = await res.json(); } catch(e) {}
    if (!res.ok || !body?.ok) {
      const msg = body?.error || body?.message || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return body;
  }

  // ---------- UI helpers ----------
  const ordersEl = document.getElementById('ordersList');
  const orderCountEl = document.getElementById('orderCount');
  const ordersNumEl = document.getElementById('ordersNum');
  const salesNumEl  = document.getElementById('salesNum');
  const listTitleEl = document.getElementById('listTitle');
  const toastEl = document.getElementById('toast');

  function money(n){ return (Math.round(n)).toLocaleString('en-PH'); }
  function showToast(t){ toastEl.textContent=t; toastEl.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>toastEl.style.display='none',2700); }

  function renderOrders(list) {
    ordersEl.innerHTML = '';
    if (!list.length) {
      ordersEl.innerHTML = '<div class="empty">No orders.</div>';
      return;
    }
    for (const o of list) {
      const card = document.createElement('div');
      card.className = 'order';
      const when = new Date(o.createdAt);
      const whenTxt = when.toLocaleString();
      const itemsTxt = (o.items||[]).map(i=>'â€¢ ' + i.category + ' â€” ' + i.amount).join('<br/>');

      const tag = (s)=>{
        if (s==='completed') return '<span class="tag t-ok">Delivered</span>';
        if (s==='out_for_delivery') return '<span class="tag t-warn">Out for delivery</span>';
        if (s==='canceled') return '<span class="tag t-bad">Canceled</span>';
        return '<span class="tag t-warn">Order confirmed</span>';
      };

      card.innerHTML = `
        <div class="row">
          <div class="id">#${o.id}</div>
          <div class="when">Received from customer: ${whenTxt}</div>
        </div>
        <div class="tags">${tag(o.status)}</div>
        <div style="margin:6px 0 8px;font-weight:800">${o.name || 'Customer'} â€¢ ${o.phone || ''}</div>
        <div>${o.address || ''}</div>
        <div style="margin-top:8px">${itemsTxt}</div>
        <div class="row-controls">
          <button class="btn-ghost" data-sendlink="${o.id}">Send link</button>
          <select class="sel" data-stage="${o.id}">
            <option value="0" ${o.statusStage===0?'selected':''}>Order confirmed</option>
            <option value="1" ${o.statusStage===1?'selected':''}>Out for delivery</option>
            <option value="2" ${o.statusStage===2?'selected':''}>Delivered</option>
            <option value="-1" ${o.statusStage===-1?'selected':''}>Cancel</option>
          </select>
          <button class="btn-ghost" data-cancel="${o.id}">Cancel</button>
        </div>`;
      ordersEl.appendChild(card);
    }

    // wire controls
    ordersEl.querySelectorAll('[data-stage]').forEach(sel=>{
      sel.addEventListener('change', async ()=>{
        const id = Number(sel.dataset.stage);
        const stage = Number(sel.value);
        try {
          await api(`/api/admin/orders/${id}/stage`, {method:'POST', body:JSON.stringify({stage})});
          showToast('Status updated');
          await loadAll(); // refresh
        } catch(e){ showToast('Update failed: '+e.message); }
      })
    });
    ordersEl.querySelectorAll('[data-sendlink]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = Number(btn.dataset.sendlink);
        const link = prompt('Paste delivery/tracking link');
        if (!link) return;
        try{
          await api(`/api/admin/orders/${id}/sendlink`, {method:'POST', body:JSON.stringify({link})});
          showToast('Link sent to customer');
          await loadAll();
        }catch(e){ showToast('Send failed: '+e.message); }
      });
    });
    ordersEl.querySelectorAll('[data-cancel]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = Number(btn.dataset.cancel);
        if (!confirm('Cancel this order?')) return;
        try{
          await api(`/api/admin/orders/${id}/stage`, {method:'POST', body:JSON.stringify({stage:-1})});
          showToast('Order canceled');
          await loadAll();
        }catch(e){ showToast('Cancel failed: '+e.message); }
      });
    });
  }

  function filterOrders(list, status) {
    if (status==='all') return list;
    if (status==='confirmed') return list.filter(o=> (o.statusStage ?? 0) === 0 && o.status!=='canceled');
    return list.filter(o => o.status === status);
  }

  function salesTotal(list, range){
    const now = new Date();
    const start = new Date(0);
    if (range==='today'){ start.setTime(now.setHours(0,0,0,0)); }
    else if (range==='week'){
      const d = new Date(); const day=(d.getDay()+6)%7; // Mon=0
      start.setTime(new Date(d.getFullYear(), d.getMonth(), d.getDate()-day).setHours(0,0,0,0));
    } else if (range==='month'){ start.setTime(new Date(now.getFullYear(), now.getMonth(), 1).setHours(0,0,0,0)); }

    let total = 0;
    for (const o of list) {
      const t = new Date(o.createdAt);
      if (t < start) continue;
      // very simple parse: sum pesos at start of each "amount" token
      for (const it of (o.items||[])) {
        const m = /â‚±\s?([\d,]+)/.exec(it.amount);
        if (m) total += Number(m[1].replace(/,/g,''));
        else if (/â‚±700/.test(it.amount)) total += 700;
      }
    }
    return total;
  }

  // ---------- Load + wire ----------
  let ALL_ORDERS = [];

  async function loadAll() {
    try {
      // shop state
      const shop = await api('/api/admin/shop');
      document.getElementById('shopToggle').checked = !!shop.open;

      // orders
      const {orders} = await api('/api/admin/orders');
      ALL_ORDERS = orders || [];
      applyFilters();
    } catch(e) {
      showToast('Auth/DB error loading orders');
    }
  }

  function applyFilters(){
    const of = document.getElementById('orderFilter').value;
    const sf = document.getElementById('salesFilter').value;

    const list = filterOrders(ALL_ORDERS, of);
    ordersNumEl.textContent = String(list.length);
    orderCountEl.textContent = String(list.length);
    listTitleEl.textContent =
      of==='all' ? 'All orders' :
      of==='confirmed' ? 'Confirmed orders' :
      of==='out_for_delivery' ? 'Out for delivery' :
      of==='completed' ? 'Delivered orders' : 'Canceled orders';

    renderOrders(list);

    const total = salesTotal(ALL_ORDERS, sf);
    salesNumEl.textContent = money(total);
  }

  // Events
  document.getElementById('btnRefresh').addEventListener('click', loadAll);
  document.getElementById('orderFilter').addEventListener('change', applyFilters);
  document.getElementById('salesFilter').addEventListener('change', applyFilters);
  document.getElementById('shopToggle').addEventListener('change', async (e)=>{
    try{
      await api('/api/admin/shop', {method:'POST', body:JSON.stringify({open:e.target.checked})});
      showToast(e.target.checked ? 'Shop opened' : 'Shop closed');
    }catch(err){
      e.target.checked = !e.target.checked;
      showToast('Toggle failed: '+err.message);
    }
  });

  // Telegram theme tweaks (optional)
  try { window.Telegram?.WebApp?.expand(); } catch(e){}

  // Go!
  loadAll();
</script>
</body>
</html>
