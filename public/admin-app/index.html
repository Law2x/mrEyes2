<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"
/>
<title>YeloðŸŸ¡Spot â€” Admin Dashboard</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#11171d;--panel-2:#0f1319;--card:#121821;
    --text:#e9eef5;--muted:#a9b4c0;--brand:#ffd54a;--ok:#27c17d;--bad:#ff6b6b;--chip:#1a2230;
    --btn:#1a2230;--btn-b:#2b3442;--badge:#222b38;--yellow:#ffcc00;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(160deg,#0a0e13 0%,#0c1117 60%,#0b0f14 100%);
    color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:920px;margin:0 auto;padding:12px 14px 56px}

  /* Header */
  .header{
    display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;
    padding:10px 0 14px;border-bottom:1px solid #121821;
  }
  .brand{
    display:flex;flex-direction:column;gap:4px;min-width:0;
  }
  .brand .name{
    font-weight:800;letter-spacing:.2px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;
    font-size:28px;line-height:28px;display:flex;align-items:center;gap:10px;
  }
  .brand .name .dot{width:10px;height:10px;border-radius:999px;background:#17d673;box-shadow:0 0 0 3px #0e1b11;display:inline-block}
  .brand .sub{font-size:12px;color:var(--muted)}

  /* Toggle + refresh â€” same size */
  .toolbar{display:flex; gap:10px}
  .pill{
    height:40px;display:flex;align-items:center;gap:10px;
    background:var(--panel);border:1px solid #1d2632;border-radius:14px;padding:0 12px;min-width:140px;
    box-shadow:0 4px 14px rgba(0,0,0,.25);
  }
  .pill .label{font-weight:700;color:#cfe0ff}
  .switch{
    width:46px;height:24px;border-radius:999px;background:#2a3545;position:relative;cursor:pointer;flex-shrink:0;
  }
  .switch::after{
    content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;
    background:#cfd8e3;transition:transform .2s ease;
  }
  .switch.on{background:#1f7a4f}
  .switch.on::after{transform:translateX(22px);background:#dff7ec}

  .btn{
    height:40px;padding:0 14px;border-radius:14px;background:linear-gradient(180deg,#232d3b,#1b2430);
    border:1px solid #2b3442;color:#f7fbff;display:inline-flex;gap:8px;align-items:center;cursor:pointer;
    box-shadow:0 4px 14px rgba(0,0,0,.25);font-weight:700
  }
  .btn.small{height:34px;border-radius:12px;padding:0 12px}
  .btn.ok{background:linear-gradient(180deg,#1d7a50,#175f40);border-color:#1a6a47}
  .btn.danger{background:linear-gradient(180deg,#5b2222,#3c1717);border-color:#6b2828}
  .btn.yellow{background:linear-gradient(180deg,#ffdf7a,#ffc72d);border-color:#f6c32b;color:#201b07}

  /* KPI row */
  .kpis{
    display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:16px 0 18px;
  }
  .kpi{
    background:var(--card);border:1px solid #15202b;border-radius:16px;padding:14px 14px 12px;
    box-shadow:0 8px 24px rgba(0,0,0,.25)
  }
  .kpi-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .chip{
    background:var(--chip);border:1px solid #243041;color:#c7d2e2;padding:6px 10px;border-radius:10px;font-weight:700
  }
  .kpi-title{font-size:18px;font-weight:800}
  .kpi-value{font-size:38px;font-weight:900;letter-spacing:.5px}

  /* orders list */
  .h2{font-size:22px;font-weight:900;margin:16px 0 10px}
  .list{display:flex;flex-direction:column;gap:12px}
  .card{
    background:var(--card);border:1px solid #16202b;border-radius:16px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.25)
  }
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .space{flex:1}
  .badge{background:var(--badge);border:1px solid #273142;border-radius:999px;padding:6px 10px;font-weight:800;color:#d7e4f7}
  .badge.green{background:#153226;border-color:#1d6b4e;color:#bfeedd}
  .badge.yellow{background:#2d2a1a;border-color:#6b5c1a;color:#ffe186}
  .badge.gray{background:#1c2531;border-color:#273142;color:#c8d2e1}
  .order-title{font-size:18px;font-weight:800}
  .items{color:#cbd7e6}

  .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
  .actions .btn{min-width:120px}

  /* Modal (send link + confirm delivered + cancel + chat) */
  .scrim{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:40}
  .hidden{display:none}
  .modal{background:var(--panel);border:1px solid #202a36;border-radius:16px;padding:14px;width:min(96vw,520px);box-shadow:0 20px 40px rgba(0,0,0,.45)}
  .modal .title{font-weight:900;margin-bottom:10px}
  .modal .field{display:flex;gap:8px}
  .input{
    width:100%;height:40px;border-radius:12px;border:1px solid #2a3444;background:#0d1015;color:#fff;padding:0 10px
  }

  /* Chat modal */
  .chat-modal{width:min(96vw,650px);max-height:85vh;display:flex;flex-direction:column}
  .chat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .chat-title{font-weight:900}
  .chat-box{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding-right:2px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:12px;line-height:1.35;white-space:pre-wrap}
  .bubble.admin{align-self:flex-end;background:#1c2a3a;color:#d9ecff}
  .bubble.customer{align-self:flex-start;background:#151a20;color:#f1f5fb}
  .meta{font-size:12px;opacity:.6;margin-top:2px}
  .chat-input{display:flex;gap:8px;margin-top:10px;border-top:1px solid #1c2531;padding-top:10px}
  .small-note{font-size:12px;color:var(--muted);margin-top:6px}

  /* success stamp */
  .stamp{
    display:inline-flex;gap:8px;align-items:center;background:#153226;border:1px solid #1d6b4e;color:#bfeedd;
    padding:8px 12px;border-radius:12px;font-weight:900
  }

  /* keep layout stable across sizes */
  @media (max-width:640px){
    .brand .name{font-size:24px}
    .kpi-value{font-size:34px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="name">
          <span class="dot" id="shopDot"></span>
          <span id="shopName">YeloðŸŸ¡Spot</span>
        </div>
        <div class="sub">Admin Dashboard</div>
      </div>

      <div class="pill" id="shopPill">
        <div class="label">Shop</div>
        <div id="shopSwitch" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
      </div>

      <button id="btnRefresh" class="btn yellow">
        <span>âŸ³ Refresh</span>
      </button>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi" id="kpiOrders">
        <div class="kpi-head">
          <div class="kpi-title">Orders</div>
          <select id="ordersFilter" class="chip" title="Filter orders">
            <option value="all" selected>All</option>
            <option value="confirmed">Confirmed</option>
            <option value="out_for_delivery">Out for delivery</option>
            <option value="completed">Delivered</option>
            <option value="canceled">Canceled</option>
          </select>
        </div>
        <div class="kpi-value" id="ordersCount">0</div>
      </div>

      <div class="kpi" id="kpiSales">
        <div class="kpi-head">
          <div class="kpi-title">Sales</div>
          <select id="salesFilter" class="chip" title="Sales timeline">
            <option value="today">Today</option>
            <option value="week">This week</option>
            <option value="month">This month</option>
            <option value="all" selected>All time</option>
          </select>
        </div>
        <div class="kpi-value"><span>â‚±</span><span id="salesTotal">0</span></div>
      </div>
    </div>

    <div class="h2">All orders</div>
    <div id="ordersList" class="list"></div>
  </div>

  <!-- Send link modal -->
  <div id="linkModal" class="scrim hidden" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="title">Send delivery / tracking link</div>
      <div class="field">
        <input id="linkInput" class="input" placeholder="https://â€¦">
        <button id="linkSend" class="btn ok">Send</button>
        <button id="linkCancel" class="btn">Close</button>
      </div>
      <div class="small-note">Customer will receive the link and a <b>Mark as Received</b> button.</div>
    </div>
  </div>

  <!-- Chat modal -->
  <div id="chatModal" class="scrim hidden" role="dialog" aria-modal="true">
    <div class="modal chat-modal">
      <div class="chat-header">
        <div class="chat-title">ðŸ’¬ Chat â€¢ Order <span id="chatOrderId"></span></div>
        <button id="chatClose" class="btn small">âœ•</button>
      </div>
      <div id="chatBox" class="chat-box"></div>
      <div class="chat-input">
        <input id="chatText" class="input" placeholder="Type a messageâ€¦">
        <button id="chatSend" class="btn ok">Send</button>
      </div>
    </div>
  </div>

<script>
/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
const ordersListEl = $("#ordersList");
const ordersCountEl = $("#ordersCount");
const salesTotalEl  = $("#salesTotal");
const salesFilterEl = $("#salesFilter");
const ordersFilterEl = $("#ordersFilter");
const shopSwitchEl  = $("#shopSwitch");
const shopDotEl     = $("#shopDot");

let STATE = {
  orders: [],
  salesTotal: 0,
  shopOpen: true,
  linkOrderId: null,
  chat: { orderId: null, poll: null }
};

// Telegram WebApp auth header
function authHeaders() {
  const initData = window.Telegram?.WebApp?.initData || '';
  return {
    "Content-Type": "application/json",
    "X-Telegram-Init-Data": initData
  };
}

function peso(n){
  return Number(n||0).toLocaleString("en-PH",{maximumFractionDigits:0});
}

function createdWithin(ts, range){
  const t = new Date(ts).getTime();
  const now = Date.now();
  const startOfToday = new Date(); startOfToday.setHours(0,0,0,0);
  if(range==="today") return t >= startOfToday.getTime();
  if(range==="week"){
    const d = new Date(now); const day = d.getDay(); // 0 Sun
    const diffToMon = (day+6)%7; d.setDate(d.getDate()-diffToMon);
    d.setHours(0,0,0,0);
    return t >= d.getTime();
  }
  if(range==="month"){
    const d = new Date(); d.setDate(1); d.setHours(0,0,0,0);
    return t >= d.getTime();
  }
  return true; // all
}

function statusToBadge(status){
  if(status==="completed") return `<span class="badge green">delivered</span>`;
  if(status==="out_for_delivery") return `<span class="badge yellow">confirmed</span>`;
  if(status==="canceled") return `<span class="badge gray">canceled</span>`;
  return `<span class="badge gray">confirmed</span>`;
}

function safeItemsText(items){
  try{
    const arr = Array.isArray(items) ? items : (items ? JSON.parse(items) : []);
    if(!arr.length) return "â€”";
    return arr.map(i=>`â€¢ ${i.category.replaceAll("_"," ")} â€” ${i.amount}`).join("<br>");
  }catch{ return "â€”"; }
}

/* ========= Fetchers ========= */
async function fetchHealth(){
  try{
    const r = await fetch("/health");
    const j = await r.json();
    if(j?.ok !== undefined){
      STATE.shopOpen = !!j.shop_open;
      renderShopToggle();
    }
  }catch{}
}

async function fetchOrders(){
  const r = await fetch("/api/admin/orders", { headers: authHeaders() });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || "load_failed");
  STATE.orders = j.orders || [];
  computeAndRender();
}

async function setShopOpen(open){
  const r = await fetch("/api/admin/shop", {
    method:"POST",
    headers: authHeaders(),
    body: JSON.stringify({ open: !!open })
  });
  const j = await r.json().catch(()=>({ok:false}));
  if(!j.ok) throw new Error(j.error || "shop_toggle_failed");
}

async function postStage(id, stage){
  return fetch(`/api/admin/orders/${id}/stage`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify({ stage })
  }).then(r=>r.json());
}

async function postLink(id, link){
  return fetch(`/api/admin/orders/${id}/sendlink`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify({ link })
  }).then(r=>r.json());
}

async function fetchChat(orderId){
  const r = await fetch(`/api/admin/orders/${orderId}/messages`, { headers: authHeaders() });
  return r.json();
}
async function sendChat(orderId, message){
  const r = await fetch(`/api/admin/orders/${orderId}/messages`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify({ message })
  });
  return r.json();
}

/* ========= Rendering ========= */
function renderShopToggle(){
  if(STATE.shopOpen){
    shopSwitchEl.classList.add("on");
    shopSwitchEl.setAttribute("aria-checked","true");
    shopDotEl.style.background = "#17d673";
  }else{
    shopSwitchEl.classList.remove("on");
    shopSwitchEl.setAttribute("aria-checked","false");
    shopDotEl.style.background = "#9b9b9b";
  }
}

function computeAndRender(){
  // KPI counts
  const filter = ordersFilterEl.value;
  const filtered = STATE.orders.filter(o => filter==="all" ? true : o.status===filter);
  ordersCountEl.textContent = filtered.length;

  // Sales
  const range = salesFilterEl.value;
  const delivered = STATE.orders.filter(o => o.status==="completed" && createdWithin(o.createdAt, range));
  const total = delivered.reduce((sum,o)=>{
    try{
      const items = Array.isArray(o.items) ? o.items : JSON.parse(o.items||"[]");
      // best-effort: parse pesos at start of each amount
      let t = 0;
      for(const it of items){
        const m = String(it.amount||"").match(/â‚±\s*([\d,]+)/);
        if(m) t += Number(m[1].replace(/,/g,""));
      }
      return sum + t;
    }catch{ return sum; }
  },0);
  salesTotalEl.textContent = peso(total);

  // Orders list
  ordersListEl.innerHTML = "";
  for(const o of STATE.orders){
    if(filter!=="all" && o.status!==filter) continue;

    const delivered = o.status === "completed";
    const canceled  = o.status === "canceled";

    const outer = document.createElement("div");
    outer.className = "card";

    // top row badges
    const top = document.createElement("div");
    top.className = "row";
    top.innerHTML = `
      <span class="badge gray">#${o.id}</span>
      ${statusToBadge(o.status)}
      <span class="space"></span>
      <span class="badge gray">${new Date(o.createdAt).toLocaleString()}</span>
    `;
    outer.appendChild(top);

    // title
    const title = document.createElement("div");
    title.className = "order-title";
    title.textContent = `${o.name || "â€”"} â€¢ ${o.phone || ""}`.trim();
    outer.appendChild(title);

    // address
    const addr = document.createElement("div");
    addr.className = "items"; addr.style.margin = "6px 0 4px";
    addr.textContent = o.address || "â€”";
    outer.appendChild(addr);

    // items list
    const items = document.createElement("div");
    items.className = "items";
    items.innerHTML = safeItemsText(o.items);
    outer.appendChild(items);

    // success stamp view if delivered
    if(delivered){
      const stamp = document.createElement("div");
      stamp.style.marginTop = "10px";
      stamp.innerHTML = `<span class="stamp">âœ… Delivered</span>`;
      outer.appendChild(stamp);
    }

    // actions
    const actions = document.createElement("div");
    actions.className = "actions";

    if(!delivered && !canceled){
      const btnLink = document.createElement("button");
      btnLink.className = "btn";
      btnLink.textContent = "Send link";
      btnLink.onclick = ()=> openLinkModal(o.id);
      actions.appendChild(btnLink);

      const btnStage = document.createElement("button");
      btnStage.className = "btn ok";
      btnStage.textContent = o.status==="out_for_delivery" ? "Delivered" : "Out for delivery";
      btnStage.onclick = async ()=>{
        if(o.status==="out_for_delivery"){ await postStage(o.id,2); }
        else { await postStage(o.id,1); }
        await reload();
      };
      actions.appendChild(btnStage);

      const btnChat = document.createElement("button");
      btnChat.className = "btn";
      btnChat.textContent = "ðŸ’¬ Chat";
      btnChat.onclick = ()=> openChat(o.id);
      actions.appendChild(btnChat);

      const btnCancel = document.createElement("button");
      btnCancel.className = "btn danger";
      btnCancel.textContent = "Cancel";
      btnCancel.onclick = async ()=>{
        if(!confirm("Cancel this order?")) return;
        await postStage(o.id,-1);
        await reload();
      };
      actions.appendChild(btnCancel);
    }

    outer.appendChild(actions);
    ordersListEl.appendChild(outer);
  }
}

/* ========= Link modal ========= */
function openLinkModal(id){
  STATE.linkOrderId = id;
  $("#linkInput").value = "";
  $("#linkModal").classList.remove("hidden");
}
function closeLinkModal(){
  $("#linkModal").classList.add("hidden");
  STATE.linkOrderId = null;
}

/* ========= Chat modal ========= */
async function openChat(id){
  STATE.chat.orderId = id;
  $("#chatOrderId").textContent = id;
  $("#chatBox").innerHTML = "";
  $("#chatModal").classList.remove("hidden");
  await loadChat();
  if(STATE.chat.poll) clearInterval(STATE.chat.poll);
  STATE.chat.poll = setInterval(loadChat, 3000);
}
function closeChat(){
  $("#chatModal").classList.add("hidden");
  if(STATE.chat.poll) clearInterval(STATE.chat.poll);
  STATE.chat.poll = null;
  STATE.chat.orderId = null;
}
async function loadChat(){
  if(!STATE.chat.orderId) return;
  const j = await fetchChat(STATE.chat.orderId);
  if(!j.ok) return;
  const box = $("#chatBox"); box.innerHTML = "";
  for(const m of j.messages||[]){
    const b = document.createElement("div");
    b.className = "bubble " + (m.sender==="admin"?"admin":"customer");
    b.textContent = m.message;
    const meta = document.createElement("div"); meta.className="meta";
    meta.textContent = new Date(m.created_at).toLocaleString();
    box.appendChild(b); box.appendChild(meta);
  }
  box.scrollTop = box.scrollHeight;
}

/* ========= Events ========= */
$("#btnRefresh").onclick = reload;
ordersFilterEl.onchange = computeAndRender;
salesFilterEl.onchange  = computeAndRender;

shopSwitchEl.addEventListener("click", async ()=>{
  try{
    STATE.shopOpen = !STATE.shopOpen;
    renderShopToggle();
    await setShopOpen(STATE.shopOpen);
  }catch(e){
    // revert visual
    STATE.shopOpen = !STATE.shopOpen;
    renderShopToggle();
    alert("Failed to toggle shop. Please try again.");
  }
});
shopSwitchEl.addEventListener("keydown", (e)=>{
  if(e.key===" "||e.key==="Enter"){ e.preventDefault(); shopSwitchEl.click(); }
});

$("#linkSend").onclick = async ()=>{
  const link = $("#linkInput").value.trim();
  if(!link) return;
  await postLink(STATE.linkOrderId, link);
  closeLinkModal();
  await reload();
};
$("#linkCancel").onclick = closeLinkModal;

$("#chatClose").onclick = closeChat;
$("#chatSend").onclick = async ()=>{
  const t = $("#chatText").value.trim();
  if(!t || !STATE.chat.orderId) return;
  $("#chatText").value = "";
  await sendChat(STATE.chat.orderId, t);
  await loadChat();
};
$("#chatText").addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); $("#chatSend").click(); }
});

/* ========= Boot ========= */
async function reload(){
  // ensure we have initData; if not, show gentle message
  const hasInit = !!(window.Telegram?.WebApp?.initData);
  if(!hasInit){
    alert("Failed to load orders: missing initData");
    return;
  }
  await Promise.all([fetchHealth(), fetchOrders()]);
}
window.addEventListener("load", () => {
  try{ window.Telegram?.WebApp?.ready?.(); }catch{}
  reload();
});
</script>
</body>
</html>
