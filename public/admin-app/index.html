<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>YeloðŸŸ¡Spot â€” Admin</title>
<style>
  :root{
    --bg:#0a0f15; --panel:#0f1520; --soft:#101826; --line:#1f2a3a;
    --text:#e8eef7; --muted:#9aa6b2; --brand:#ffd400;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --accent:#273249;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0b1422 70%);
    color:var(--text); font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .app{max-width:920px;margin:0 auto;padding:16px 14px 60px}
  .topbar{display:flex;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px}
  .brand .dot{width:18px;height:18px;border-radius:50%;background:var(--brand)}
  .spacer{flex:1}
  .switch{
    display:inline-flex;align-items:center;background:#0e1726;border:1px solid var(--line);
    padding:4px 8px;border-radius:999px;gap:10px
  }
  .switch input{appearance:none;width:44px;height:24px;background:#1c2535;border-radius:999px;position:relative;outline:none;border:1px solid #2a364c;cursor:pointer}
  .switch input:checked{background:#163221;border-color:#1f6f41}
  .switch input:before{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:#cfd7e6;border-radius:50%;transition:transform .18s}
  .switch input:checked:before{transform:translateX(20px);background:#7fffb4}
  .btn{background:#1a2333;border:1px solid #2a364c;color:#dbe2ea;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.small{padding:8px 12px;border-radius:10px}
  .btn.yellow{background:#2b210b;border-color:#5a4413;color:#ffd97a}
  .summary{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:14px 0 6px}
  .tile{background:linear-gradient(180deg,#0f1520,#0b121d);border:1px solid var(--line);border-radius:14px;padding:14px 16px;box-shadow:var(--shadow)}
  .tile h4{margin:0 0 8px 0;color:#b8c6d8}
  .big{font-size:26px;font-weight:800}
  .muted{color:var(--muted)}
  .section-title{font-weight:800;font-size:18px;margin:18px 0 10px}
  .card{
    background:linear-gradient(180deg,var(--panel),var(--soft)); border:1px solid var(--line);
    border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;
    margin:12px 0;
  }
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .idpill{background:#0d1626;border:1px solid var(--line);padding:5px 10px;border-radius:999px;color:#a7b5c7;font-weight:700}
  .badge{background:#0d1626;border:1px solid var(--line);padding:5px 10px;border-radius:999px;font-weight:700;color:#cbd5e1}
  .badge.confirmed{border-color:#3a455c}
  .badge.out{border-color:#3aa3ff;color:#cfeaff;background:#0d1723}
  .badge.done{border-color:#22c55e;color:#b8f6c2;background:#0f1b12}
  .badge.cancel{border-color:#ef4444;color:#fecaca;background:#220e12}
  .when{background:#0d1626;border:1px solid var(--line);color:#a7b5c7;border-radius:999px;padding:5px 10px}
  .title{font-weight:900;font-size:18px;margin:10px 0 6px 0}
  .list{padding-left:18px;margin:6px 0;color:#dbe3ee}
  .list li{margin:2px 0}
  .card-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn.red{background:#2b1417;border-color:#5a1e25;color:#ffc9c9}
  .divider{height:1px;background:var(--line);margin:12px 0}
  /* chat in card */
  .chat{
    background:#0b111b;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px
  }
  .msg-list{display:flex;flex-direction:column;gap:10px;min-height:80px;max-height:200px;overflow:auto;padding-right:6px}
  .msg{display:flex}
  .msg .bub{max-width:85%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);white-space:pre-wrap}
  .msg.customer{justify-content:flex-start}
  .msg.customer .bub{background:#141c28}
  .msg.admin{justify-content:flex-end}
  .msg.admin .bub{background:#10213a}
  .msgmeta{font-size:11px;color:#9aa6b2;margin-bottom:4px}
  .chat-entry{display:flex;gap:8px;margin-top:8px}
  .chat-entry textarea{flex:1;min-height:42px;resize:vertical;background:#0e1523;border:1px solid #1f2937;border-radius:10px;color:var(--text);padding:10px}
  .empty{color:var(--muted)}
  /* unauthorized banner */
  .unauth{background:#1b1210;border:1px solid #3e2a24;color:#ffd6b5;padding:12px;border-radius:12px;margin:10px 0}
</style>
</head>
<body>
  <div class="app">
    <!-- header -->
    <div class="topbar">
      <div class="brand">Yelo<span class="dot"></span>Spot</div>
      <div class="spacer"></div>
      <label class="switch">
        <span class="muted">Shop</span>
        <input id="shopToggle" type="checkbox" />
      </label>
      <button id="btnRefresh" class="btn yellow">âŸ³ Refresh</button>
    </div>

    <!-- summary -->
    <div class="summary">
      <div class="tile">
        <h4>Orders</h4>
        <div class="row">
          <div id="ordersCount" class="big">0</div>
          <select id="ordersRange" class="btn small" style="margin-left:auto">
            <option value="all">All</option>
            <option value="today">Today</option>
          </select>
        </div>
      </div>
      <div class="tile">
        <h4>Sales</h4>
        <div class="row">
          <div class="big">â‚±<span id="salesTotal">0</span></div>
          <select id="salesRange" class="btn small" style="margin-left:auto">
            <option value="today">Today</option>
            <option value="all">All time</option>
          </select>
        </div>
      </div>
    </div>

    <div id="unauth" class="unauth" style="display:none">
      <b>Unauthorized:</b> Please open inside Telegram (Admin WebApp).
    </div>

    <div class="section-title">All orders</div>
    <div id="cards"></div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ---------------- Telegram WebApp auth ---------------- */
    const tg = window.Telegram?.WebApp;
    let initData = "";
    let insideTG = false;

    if (tg && tg.initData) {
      insideTG = true;
      initData = tg.initData;
      tg.ready(); tg.expand && tg.expand();
    } else {
      const qp = new URLSearchParams(location.search);
      initData = qp.get("initData") || "";
      insideTG = !!initData;
    }
    document.getElementById("unauth").style.display = insideTG ? "none" : "block";

    /* ---------------- small helpers ---------------- */
    const $ = (s)=>document.querySelector(s);
    const cards = $("#cards");
    const shopToggle = $("#shopToggle");
    const btnRefresh = $("#btnRefresh");
    const peso = (n)=> new Intl.NumberFormat("en-PH").format(n||0);
    const fmt = (iso)=> { try{ return new Date(iso).toLocaleString(); }catch{ return iso||"-"; } };
    const api = async (path, method="GET", body) => {
      const res = await fetch(path, {
        method,
        headers:{
          "Content-Type":"application/json",
          "X-Telegram-Init-Data": initData
        },
        body: body? JSON.stringify(body): undefined
      });
      const j = await res.json().catch(()=>({}));
      if (!j?.ok) throw new Error(j?.error || "api_error");
      return j;
    };
    const esc = (s)=> (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    /* ---------------- state ---------------- */
    let ORDERS = [];
    const POLL = new Map(); // orderId -> intervalId

    /* ---------------- render ---------------- */
    function badgeFor(stage){
      if (stage === 2) return '<span class="badge done">delivered</span>';
      if (stage === 1) return '<span class="badge out">out for delivery</span>';
      if (stage === -1) return '<span class="badge cancel">canceled</span>';
      return '<span class="badge confirmed">confirmed</span>';
    }
    function itemsList(items){
      if (!items?.length) return "";
      return `<ul class="list">${items.map(i=>`<li>${esc(i.category)} â€” ${esc(i.amount)}`).join("")}</ul>`;
    }

    function cardHtml(o){
      return `
      <div class="card" data-id="${o.id}">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <div class="idpill">#${o.id}</div>
            ${badgeFor(Number(o.statusStage ?? 0))}
            <div class="when">${fmt(o.createdAt)}</div>
          </div>
          <!-- right side kept clean -->
        </div>

        <div class="title">${esc(o.name || "â€”")} â€¢ ${esc(o.phone || o.customerChatId || "")}</div>
        <div class="muted" style="margin-bottom:6px">${esc(o.address || "")}</div>

        ${itemsList(o.items)}

        <!-- delivered banner -->
        ${Number(o.statusStage)===2 ? `
          <div class="row" style="align-items:flex-start; gap:12px; margin-top:10px">
            <div style="width:36px;height:36px;border-radius:50%;border:2px solid #1e9b57;display:flex;align-items:center;justify-content:center;color:#86f7b9">âœ“</div>
            <div>
              <div style="font-weight:800">Delivered</div>
              <div class="muted">This order is complete. Actions are disabled.</div>
            </div>
          </div>` : ""}

        <div class="card-actions">
          ${Number(o.statusStage)===2 ? "" : `
            <button class="btn small" data-act="sendlink">Send link</button>
            <button class="btn small" data-act="stage1">Order confirmed</button>
            <button class="btn small red" data-act="cancel">Cancel</button>
          `}
          <button class="btn small" data-act="toggle-chat">Chat</button>
        </div>

        <div class="chat" id="chat-${o.id}" style="display:none">
          <div class="msg-list" id="msgs-${o.id}"><div class="empty">No messages yet.</div></div>
          <div class="chat-entry">
            <textarea id="input-${o.id}" placeholder="Type a message to customerâ€¦"></textarea>
            <button class="btn" data-act="sendmsg">Send</button>
          </div>
        </div>
      </div>`;
    }

    function render(){
      cards.innerHTML = ORDERS.map(cardHtml).join("") || `<div class="muted">No orders yet.</div>`;
      // sales + counts
      $("#ordersCount").textContent = String(ORDERS.length);
      const total = ORDERS.reduce((sum,o)=>{
        // quick best-effort parse: add â‚±700 for each poppers item and try to parse numeric for others
        const items = o.items || [];
        let t = 0;
        items.forEach(it=>{
          const m = /â‚±\s*([\d,]+)/.exec(String(it.amount));
          if (m) t += Number(m[1].replace(/,/g,"")) || 0;
          else if ((it.category||"").startsWith("poppers")) t += 700;
        });
        return sum + t;
      },0);
      $("#salesTotal").textContent = peso(total);
    }

    /* ---------------- load data ---------------- */
    async function loadShop(){
      try{
        const j = await api("/api/admin/shop");
        shopToggle.checked = !!j.open;
      }catch{}
    }
    async function loadOrders(){
      try{
        const j = await api("/api/admin/orders");
        ORDERS = j.orders || [];
        render();
      }catch(e){
        console.error(e);
      }
    }

    /* ---------------- chat ---------------- */
    async function loadMessages(orderId){
      const box = document.getElementById(`msgs-${orderId}`);
      try{
        const j = await api(`/api/admin/orders/${orderId}/messages`);
        const msgs = j.messages || [];
        if (!msgs.length){
          box.innerHTML = '<div class="empty">No messages yet.</div>';
          return;
        }
        box.innerHTML = msgs.map(m=>{
          const who = m.sender === 'admin' ? 'admin' : 'customer';
          const when = fmt(m.created_at || m.createdAt);
          return `<div class="msg ${who}">
                    <div class="bub">
                      <div class="msgmeta">${who === 'admin' ? 'Admin' : 'Customer'} â€¢ ${when}</div>
                      ${esc(m.message || '')}
                    </div>
                  </div>`;
        }).join("");
        box.scrollTop = box.scrollHeight;
      }catch(e){
        box.innerHTML = '<div class="empty">Failed to load messages.</div>';
      }
    }

    function startPolling(orderId){
      stopPolling(orderId);
      const id = setInterval(()=>loadMessages(orderId), 5000);
      POLL.set(orderId, id);
    }
    function stopPolling(orderId){
      const id = POLL.get(orderId);
      if (id){ clearInterval(id); POLL.delete(orderId); }
    }

    /* ---------------- events ---------------- */
    // toggle shop (server already exposes GET/POST)
    shopToggle.addEventListener("change", async ()=>{
      try{
        await api("/api/admin/shop","POST",{ open: shopToggle.checked });
      }catch(e){
        // revert if failed
        shopToggle.checked = !shopToggle.checked;
      }
    });

    btnRefresh.addEventListener("click", async ()=>{
      await Promise.all([loadShop(), loadOrders()]);
    });

    // delegate clicks inside cards
    cards.addEventListener("click", async (ev)=>{
      const card = ev.target.closest(".card");
      if (!card) return;
      const id = Number(card.dataset.id);
      const act = ev.target.dataset.act;

      if (act === "toggle-chat"){
        const wrap = document.getElementById(`chat-${id}`);
        const show = wrap.style.display === "none";
        wrap.style.display = show ? "block" : "none";
        if (show){ await loadMessages(id); startPolling(id); } else { stopPolling(id); }
        return;
      }
      if (act === "sendmsg"){
        const ta = document.getElementById(`input-${id}`);
        const text = ta.value.trim();
        if (!text) return;
        try{
          await api(`/api/admin/orders/${id}/messages`, "POST", { message: text });
          ta.value = "";
          await loadMessages(id);
        }catch(e){ alert("Failed to send message."); }
        return;
      }
      if (act === "sendlink"){
        const link = prompt("Enter delivery/tracking link:");
        if (!link) return;
        try{
          await api(`/api/admin/orders/${id}/sendlink`, "POST", { link });
          alert("Link sent.");
          await loadOrders();
        }catch(e){ alert("Failed to send link."); }
        return;
      }
      if (act === "stage1"){
        try{
          await api(`/api/admin/orders/${id}/stage`, "POST", { stage: 1 });
          await loadOrders();
        }catch(e){ alert("Failed to update stage."); }
        return;
      }
      if (act === "cancel"){
        if (!confirm("Cancel this order?")) return;
        try{
          await api(`/api/admin/orders/${id}/stage`, "POST", { stage: -1 });
          await loadOrders();
        }catch(e){ alert("Cancel failed."); }
        return;
      }
    });

    /* ---------------- init ---------------- */
    (async function init(){
      await loadShop();
      await loadOrders();
    })();
  </script>
</body>
</html>
