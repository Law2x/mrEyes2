<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YeloðŸŸ¡Spot â€” Admin</title>
<style>
  :root{
    --bg:#0f1115;--panel:#161a20;--panel-2:#1b1f27;--text:#e8eefc;--muted:#a9b3c7;
    --brand:#ffd54a;--ok:#36d399;--warn:#fbbf24;--danger:#ef4444;--shadow:0 8px 24px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; overflow-x:hidden; background:#0f1115; color:var(--text);
    font:15px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    background:
      radial-gradient(1100px 520px at 130% -10%, rgba(255,213,74,.08), transparent 60%),
      linear-gradient(180deg, #0e1114 0%, #0f1115 100%);
  }

  /* header */
  .bar{position:sticky;top:0;z-index:20;background:rgba(15,17,21,.78);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
  .bar__row{max-width:980px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:800}
  .dot{width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff,#ffe07a 30%,#ffc107 60%,#b58900 100%);box-shadow:0 0 0 3px rgba(255,213,74,.12)}
  .muted{color:var(--muted);font-weight:600}
  .spacer{flex:1}

  /* controls (toggle + small refresh stacked) */
  .controls{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
  .switch{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--panel-2);border-radius:999px;box-shadow:var(--shadow)}
  .switch label{font-weight:800}
  .toggle{appearance:none;-webkit-appearance:none;width:48px;height:26px;border-radius:999px;background:#2a2f3a;position:relative;outline:none;cursor:pointer;transition:.2s}
  .toggle:before{content:"";position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:.25s;box-shadow:0 2px 8px rgba(0,0,0,.35)}
  .toggle:checked{background:#1f4d2f}
  .toggle:checked:before{transform:translateX(22px);background:#34d399}
  .btn{border:none;color:#0f1115;background:linear-gradient(180deg,#ffe27a,#ffc62b);border-radius:12px;font-weight:800;padding:6px 10px;display:inline-flex;align-items:center;gap:6px;cursor:pointer;box-shadow:var(--shadow);font-size:13px}
  .btn:active{transform:translateY(1px)}

  /* main wrap */
  .wrap{max-width:980px;margin:0 auto;padding:12px 14px 80px}

  /* METRICS single row (orders + sales on one line) */
  .metrics{
    display:flex;gap:10px;align-items:stretch;min-width:0; /* prevent overflow */
  }
  .metric{flex:1 1 0;min-width:0;background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;box-shadow:var(--shadow);padding:10px}
  .row{display:flex;align-items:center;gap:8px;min-width:0}
  .title{font-weight:800}
  .select{appearance:none;-webkit-appearance:none;color:var(--text);background:var(--panel-2);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px 10px;font-weight:700;outline:none;min-width:0;max-width:55%}
  .value{font-size:34px;font-weight:900;margin-top:6px;display:flex;align-items:baseline;gap:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .peso{font-size:18px;opacity:.75}
  .chip{margin-left:auto;background:rgba(255,255,255,.08);border-radius:9px;min-width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;font-weight:900}

  /* list */
  .list-title{margin:14px 2px 8px;font-weight:800;color:var(--muted)}
  .order{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px;margin-bottom:12px;box-shadow:var(--shadow)}
  .order__head{display:flex;align-items:center;gap:10px;justify-content:space-between}
  .badge{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid rgba(255,255,255,.06)}
  .b--ok{background:rgba(54,211,153,.15);color:#a8ffdc}
  .b--warn{background:rgba(251,191,36,.15);color:#ffe9b0}
  .b--muted{background:rgba(149,156,172,.18);color:#d5dceb}
  .b--danger{background:rgba(239,68,68,.18);color:#ffd1d1}
  .order__meta{color:var(--muted);margin:6px 0 4px;font-weight:600}
  .order__name{font-size:17px;font-weight:900;min-width:0}
  .order__addr{color:#c7d2e5}
  .items{margin:6px 0 8px;color:#dfe7f6}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn-sm{border:1px solid rgba(255,255,255,.08);background:var(--panel-2);color:var(--text);padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer}
  .btn-danger{border-color:rgba(239,68,68,.35);color:#ffd1d1}
  select[data-act="stage"]{padding:7px 10px}

  /* small screens tweaks */
  @media (max-width:380px){
    .value{font-size:28px}
    .select{max-width:60%}
  }
</style>
</head>
<body>
<header class="bar">
  <div class="bar__row">
    <div class="logo"><span class="dot"></span>Yelo<span class="dot" style="margin-left:-4px"></span>Spot <span class="muted">â€” Admin Dashboard</span></div>
    <div class="spacer"></div>
    <div class="controls">
      <div class="switch">
        <label>Shop</label>
        <input id="shopToggle" type="checkbox" class="toggle" />
      </div>
      <button id="btnRefresh" class="btn" title="Refresh">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
          <path d="M21 12a9 9 0 1 1-2.64-6.36M21 4v6h-6" stroke="#242424" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Refresh
      </button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- ONE LINE metrics -->
  <section class="metrics">
    <div class="metric">
      <div class="row">
        <div class="title">Orders</div>
        <span id="ordersCountChip" class="chip">0</span>
        <select id="ordersFilter" class="select" style="margin-left:auto">
          <option value="all">All</option>
          <option value="confirmed">Order confirmed</option>
          <option value="out_for_delivery">Out for delivery</option>
          <option value="completed">Delivered</option>
          <option value="canceled">Canceled</option>
        </select>
      </div>
      <div class="value" id="ordersCount"><span>0</span></div>
    </div>

    <div class="metric">
      <div class="row">
        <div class="title">Sales</div>
        <select id="salesRange" class="select" style="margin-left:auto">
          <option value="today">Today</option>
          <option value="yesterday">Yesterday</option>
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
          <option value="all">All</option>
        </select>
      </div>
      <div class="value"><span class="peso">â‚±</span><span id="salesValue">0</span></div>
    </div>
  </section>

  <h3 class="list-title" id="listTitle">All orders</h3>
  <div id="ordersList"></div>
</main>

<script type="module">
  /* Telegram init */
  const tg = window.Telegram?.WebApp; if (tg){ tg.expand?.(); tg.ready?.(); }
  const INIT_DATA = tg?.initData || (new URLSearchParams(location.search).get("initData")) || "";
  const AUTH_HEADERS = { "X-Telegram-Init-Data": INIT_DATA, "Content-Type": "application/json" };

  const $ = (q,d=document)=>d.querySelector(q);
  const elOrdersCount = $("#ordersCount");
  const elOrdersCountChip = $("#ordersCountChip");
  const elOrdersList = $("#ordersList");
  const elListTitle = $("#listTitle");
  const elOrdersFilter = $("#ordersFilter");
  const elSalesRange = $("#salesRange");
  const elSalesValue = $("#salesValue");
  const elShopToggle = $("#shopToggle");
  const btnRefresh = $("#btnRefresh");

  let ORDERS = []; let SHOP_OPEN = true;

  async function api(path, opts={}) {
    const r = await fetch(path, { ...opts, headers:{...(opts.headers||{}), ...AUTH_HEADERS} });
    if (!r.ok) throw new Error("HTTP "+r.status); return r.json();
  }
  async function loadOrders(){ const j=await api("/api/admin/orders"); if(!j.ok) throw 0; ORDERS=j.orders||[]; renderAll(); }
  async function loadShop(){ try{ const j=await api("/api/admin/shop"); if(j?.ok) SHOP_OPEN=!!j.open; }catch{} elShopToggle.checked=SHOP_OPEN; }
  async function setShop(open){ try{ await api("/api/admin/shop",{method:"POST",body:JSON.stringify({open})}); SHOP_OPEN=open; }catch{ tg?.showAlert?.("Failed to update shop status"); elShopToggle.checked=!open; } }
  async function postStage(id,stage){ await api(`/api/admin/orders/${id}/stage`,{method:"POST",body:JSON.stringify({stage})}); }
  async function postLink(id,link){ await api(`/api/admin/orders/${id}/sendlink`,{method:"POST",body:JSON.stringify({link})}); }

  function peso(n){ return (Math.round(n)).toLocaleString("en-PH"); }
  function whenShort(iso){ try{ const d=new Date(iso); return d.toLocaleString(undefined,{month:"numeric",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}); }catch{return iso;} }
  function badgeCls(s){ if(s==="completed")return"badge b--ok"; if(s==="out_for_delivery")return"badge b--warn"; if(s==="canceled")return"badge b--danger"; return"badge b--muted"; }

  function computeSales(range){
    const now=new Date(); const start=new Date(now);
    if(range==="today"){ start.setHours(0,0,0,0); }
    else if(range==="yesterday"){ start.setDate(start.getDate()-1); start.setHours(0,0,0,0); now.setTime(start.getTime()+86400000-1); }
    else if(range==="7d"){ start.setDate(start.getDate()-6); start.setHours(0,0,0,0); }
    else if(range==="30d"){ start.setDate(start.getDate()-29); start.setHours(0,0,0,0); }
    else start.setTime(0);

    let total=0;
    for(const o of ORDERS){
      const dt=new Date(o.createdAt||o.created_at||Date.now());
      if(dt<start||dt>now) continue;
      if(o.status!=="completed") continue;
      for(const it of (o.items||[])){
        const t=it.amount||""; const m=t.match(/â‚±\s*([\d,]+)/);
        if(m) total+=Number(m[1].replace(/,/g,"")); else if(/â‚±700/.test(t)) total+=700;
      }
    }
    return total;
  }

  function filterOrders(kind){
    if(kind==="all") return ORDERS;
    if(kind==="confirmed") return ORDERS.filter(o=> (o.status==="paid" || o.statusStage===0));
    return ORDERS.filter(o=> o.status===kind);
  }

  function renderCounts(){
    const kind=elOrdersFilter.value;
    const list=filterOrders(kind);
    elOrdersCount.textContent=list.length;
    elOrdersCountChip.textContent=list.length;
    elListTitle.textContent={
      all:"All orders", confirmed:"Order confirmed", out_for_delivery:"Out for delivery",
      completed:"Delivered", canceled:"Canceled"
    }[kind]||"All orders";
    elSalesValue.textContent=peso(computeSales(elSalesRange.value));
  }

  function renderOrders(){
    const list=filterOrders(elOrdersFilter.value);
    if(!list.length){ elOrdersList.innerHTML=`<div class="order">No orders yet.</div>`; return; }
    elOrdersList.innerHTML=list.map(o=>{
      const items=(o.items||[]).map(i=>`â€¢ ${i.category?.replaceAll("_"," ")} â€” ${i.amount}`).join("<br>");
      const stage=o.status==="completed"?2:o.status==="out_for_delivery"?1:o.status==="canceled"?-1:0;
      return `
        <article class="order" data-id="${o.id}">
          <div class="order__head">
            <div class="badge b--muted">#${o.id}</div>
            <div class="${badgeCls(o.status)}">${o.status.replaceAll("_"," ")}</div>
          </div>
          <div class="order__meta">Received from customer: ${whenShort(o.createdAt)}</div>
          <div class="order__name">${o.name||"â€”"} â€¢ ${o.phone||""}</div>
          <div class="order__addr">${o.address||"No address"}</div>
          <div class="items">${items||"â€”"}</div>
          <div class="actions">
            <button class="btn-sm" data-act="sendlink">Send link</button>
            <select class="select" data-act="stage">
              <option value="0" ${stage===0?"selected":""}>Order confirmed</option>
              <option value="1" ${stage===1?"selected":""}>Out for delivery</option>
              <option value="2" ${stage===2?"selected":""}>Delivered</option>
              <option value="-1" ${stage===-1?"selected":""}>Canceled</option>
            </select>
            <button class="btn-sm btn-danger" data-act="cancel">Cancel</button>
          </div>
        </article>
      `;
    }).join("");
  }

  /* events */
  elOrdersFilter.addEventListener("change", ()=>{ renderCounts(); renderOrders(); });
  elSalesRange.addEventListener("change", ()=>{ renderCounts(); });
  btnRefresh.addEventListener("click", async ()=>{
    btnRefresh.disabled=true;
    try{ await Promise.all([loadOrders(),loadShop()]); }catch{ tg?.showAlert?.("Auth/DB error loading orders"); }
    finally{ btnRefresh.disabled=false; }
  });
  elShopToggle.addEventListener("change", e=> setShop(e.target.checked));

  elOrdersList.addEventListener("click", async e=>{
    const btn=e.target.closest("[data-act]"); if(!btn)return;
    const card=e.target.closest(".order"); const id=Number(card.dataset.id);
    if(btn.dataset.act==="sendlink"){
      const link=prompt("Delivery / tracking link:"); if(!link) return;
      try{ await postLink(id,link); await loadOrders(); }catch{ tg?.showAlert?.("Failed to send link"); }
    } else if(btn.dataset.act==="cancel"){
      if(!confirm("Cancel this order?")) return;
      try{ await postStage(id,-1); await loadOrders(); }catch{ tg?.showAlert?.("Failed to cancel"); }
    }
  });
  elOrdersList.addEventListener("change", async e=>{
    const sel=e.target.closest('select[data-act="stage"]'); if(!sel) return;
    const card=e.target.closest(".order"); const id=Number(card.dataset.id);
    try{ await postStage(id, Number(sel.value)); await loadOrders(); }catch{ tg?.showAlert?.("Failed to update stage"); }
  });

  /* init */
  (async function(){ try{ await Promise.all([loadOrders(),loadShop()]); }catch{ tg?.showAlert?.("Auth/DB error loading orders"); } })();
  function renderAll(){ renderCounts(); renderOrders(); }
</script>
</body>
</html>
