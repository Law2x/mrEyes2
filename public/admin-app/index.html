<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YeloðŸŸ¡Spot â€” Admin</title>
<style>
/* ==== THEME ==== */
:root{
  --bg:#0f1115; --panel:#161a21; --panel-2:#1b2029; --border:#212735;
  --muted:#93a0b8; --text:#eef3fb; --brand:#ffd54d; --accent:#ffc400;
  --success:#18c37e; --danger:#ff5c6c;
  --r:12px; --r-sm:10px; --gap:12px; --max:980px;
}

/* ==== BASE ==== */
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial}
h1,h2,h3,p{margin:0}
small{color:var(--muted)}
.wrap{max-width:var(--max);margin:0 auto;padding:0 14px}
.nowrap{white-space:nowrap}
.ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.break{overflow-wrap:anywhere}

/* ==== TOP BAR ==== */
.bar{position:sticky;top:0;z-index:5;background:rgba(15,17,21,.92);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.06)}
.bar__row{display:flex;align-items:center;justify-content:space-between;padding:8px 14px}
.brand{display:flex;align-items:center;gap:10px}
.brand__dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff6a3 0%,#ffd54d 50%,#b78b00 100%)}
.brand__stack{display:flex;flex-direction:column}
.brand__title{font-weight:900;letter-spacing:.2px;font-size:clamp(18px,3.5vw,26px)}
.brand__subtitle{color:var(--muted);font-size:clamp(10px,2.3vw,12px);margin-top:2px}

.controls{display:flex;align-items:center;gap:10px}
.pill{height:clamp(26px,5vw,34px);display:flex;align-items:center;gap:8px;padding:0 clamp(10px,2.5vw,12px);border-radius:999px}
.switch{background:#1e2330;border:1px solid var(--border);font-weight:800}
.toggle{width:clamp(36px,8vw,42px);height:clamp(18px,4vw,22px);border-radius:20px;background:#2a2f3a;position:relative;transition:.18s;flex:0 0 auto}
.toggle:before{content:"";position:absolute;top:2px;left:2px;width:clamp(14px,3.5vw,18px);height:clamp(14px,3.5vw,18px);border-radius:50%;background:#fff;transition:.18s}
.toggle.on{background:#1f5f3e}
.toggle.on:before{transform:translateX(clamp(16px,3.7vw,20px));background:#34d399}
.btn{background:linear-gradient(180deg,#ffd86b,#ffc400);color:#242400;border:none;cursor:pointer;font-weight:800}

/* ==== SECTION ==== */
.section{padding:12px 0}

/* ==== METRICS ROW (ALWAYS TWO COLUMNS) ==== */
.metrics{
  display:grid;
  grid-template-columns: minmax(0,1fr) minmax(0,1fr);
  gap:var(--gap);
}
.metric{
  background:var(--panel-2); border:1px solid var(--border); border-radius:var(--r);
  padding:clamp(8px,2.5vw,12px); box-shadow:0 4px 12px rgba(0,0,0,.35);
  min-height:clamp(78px,17vw,92px);
}
.metric__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;gap:8px}
.metric__title{font-weight:800;font-size:clamp(13px,2.8vw,16px)}
.value{font-size:clamp(22px,6vw,28px);font-weight:900;letter-spacing:.4px}

/* Selects scale, never overflow */
.select{
  appearance:none;background:#232938;color:var(--text);border:1px solid var(--border);
  border-radius:8px;padding:clamp(4px,1vw,6px) clamp(8px,2vw,10px);
  font-size:clamp(11px,2.7vw,13px);font-weight:700;max-width:60%;
}

/* Headings */
.h2{font-weight:900;margin:18px 0 10px;font-size:clamp(18px,5vw,22px)}

/* ==== ORDER CARD ==== */
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--r);
  padding:clamp(10px,2.6vw,12px); margin-bottom:12px; box-shadow:0 6px 16px rgba(0,0,0,.35)
}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-weight:800;font-size:clamp(11px,2.8vw,12px)}
.badge--muted{background:#1f2430;color:#9aa3b7}
.badge--ok{background:#0f2a23;color:#b0ffda}
.badge--warn{background:#2a2413;color:#ffe0a6}
.title{font-weight:800;font-size:clamp(14px,3.8vw,16px);margin:6px 0}
.addr{color:var(--muted);font-size:clamp(12px,3.3vw,14px)}
.item{margin:4px 0;font-size:clamp(12px,3.3vw,14px)}
.btn-sm{border:none;border-radius:8px;padding:7px 12px;font-size:clamp(11px,3vw,12px);font-weight:700;cursor:pointer}
.btn-ghost{background:#232938;color:var(--text)}
.btn-danger{background:var(--danger);color:#fff}

/* Prevent any horizontal scroll */
html,body{overflow-x:hidden}
.wrap,.metrics,.metric,.card{min-width:0}
</style>
</head>
<body>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- ====== TOP BAR ====== -->
<div class="bar">
  <div class="bar__row wrap">
    <div class="brand">
      <span class="brand__dot"></span>
      <div class="brand__stack">
        <div class="brand__title">YeloðŸŸ¡Spot</div>
        <div class="brand__subtitle">Admin dashboard</div>
      </div>
    </div>
    <div class="controls">
      <div class="pill switch">
        <span style="font-weight:800;font-size:clamp(12px,3.2vw,14px)">Shop</span>
        <div id="shopToggle" class="toggle" role="switch" aria-checked="false" tabindex="0"></div>
      </div>
      <button id="btnRefresh" class="pill btn" style="font-size:clamp(12px,3.2vw,14px)">âŸ³ Refresh</button>
    </div>
  </div>
</div>

<!-- ====== CONTENT ====== -->
<div class="wrap section">
  <div class="metrics" id="metricsRow">
    <!-- Orders -->
    <div class="metric">
      <div class="metric__head">
        <div class="metric__title">Orders</div>
        <select id="ordersFilter" class="select" aria-label="Orders filter">
          <option value="all">All</option>
          <option value="confirmed">Confirmed</option>
          <option value="out">Out for delivery</option>
          <option value="delivered">Delivered</option>
          <option value="canceled">Canceled</option>
        </select>
      </div>
      <div class="value" id="ordersCount">0</div>
    </div>

    <!-- Sales -->
    <div class="metric">
      <div class="metric__head">
        <div class="metric__title">Sales</div>
        <select id="salesRange" class="select" aria-label="Sales range">
          <option value="today">Today</option>
          <option value="week">This week</option>
          <option value="month">This month</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div class="value">â‚±<span id="salesValue">0</span></div>
    </div>
  </div>

  <h2 class="h2">All orders</h2>
  <div id="ordersList"></div>
</div>

<script>
  const tg = window.Telegram?.WebApp; tg?.ready?.(); tg?.expand?.();

  const authHeaders = () => ({
    'X-Telegram-Init-Data': tg?.initData || '',
    'Content-Type': 'application/json'
  });

  let ORDERS = [];

  // ---- Fetch & render ----
  async function fetchOrders(){
    try{
      const r = await fetch('/api/admin/orders', { headers: authHeaders() });
      const j = await r.json();
      if(!j.ok) throw new Error('not ok');
      ORDERS = j.orders || [];
      renderAll();
    }catch(e){
      console.error('Auth/DB error loading orders', e);
      document.getElementById('ordersList').innerHTML =
        '<div class="card">Auth/DB error loading orders</div>';
    }
  }

  const peso = n => Math.round(n).toLocaleString('en-PH');
  const keyByStage = s => (s===-1?'canceled':s===1?'out':s===2?'delivered':'confirmed');

  function saleFromItems(items){
    let sum = 0;
    for(const it of (items||[])){
      const m = (it.amount||'').match(/â‚±\s*([\d,]+)/);
      if(m) sum += Number(m[1].replace(/,/g,''));
    }
    return sum;
  }

  function inRange(iso, range){
    const t = new Date(iso), now = new Date();
    if(range==='today'){
      const a = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const b = new Date(a); b.setDate(a.getDate()+1);
      return t>=a && t<b;
    }
    if(range==='week'){
      const a = new Date(now); a.setDate(now.getDate() - now.getDay()); a.setHours(0,0,0,0);
      const b = new Date(a); b.setDate(a.getDate()+7);
      return t>=a && t<b;
    }
    if(range==='month'){
      const a = new Date(now.getFullYear(), now.getMonth(), 1);
      const b = new Date(now.getFullYear(), now.getMonth()+1, 1);
      return t>=a && t<b;
    }
    return true;
  }

  function renderAll(){
    // Orders count by filter
    const f = document.getElementById('ordersFilter').value;
    const filtered = ORDERS.filter(o => f==='all' || keyByStage(o.statusStage)===f);
    document.getElementById('ordersCount').textContent = filtered.length;

    // Sales
    const range = document.getElementById('salesRange').value;
    const sales = ORDERS
      .filter(o => keyByStage(o.statusStage)==='delivered' && inRange(o.createdAt, range))
      .reduce((a,o)=>a + saleFromItems(o.items), 0);
    document.getElementById('salesValue').textContent = peso(sales);

    // List
    const list = document.getElementById('ordersList');
    list.innerHTML = filtered.map(o => {
      const stage = keyByStage(o.statusStage);
      const badgeClass = stage==='delivered' ? 'badge--ok' :
                         stage==='out'       ? 'badge--warn' : 'badge--muted';
      return `
      <div class="card">
        <div class="row">
          <span class="badge badge--muted">#${o.id}</span>
          <span class="badge ${badgeClass}">${stage}</span>
          <span class="badge badge--muted">${new Date(o.createdAt).toLocaleString()}</span>
        </div>
        <div class="title ellipsis">${o.name || 'Customer'} â€¢ ${o.phone || ''}</div>
        <div class="addr break">${o.address || ''}</div>
        <div class="item break">${(o.items||[]).map(i=>`â€¢ ${i.category} â€” ${i.amount}`).join('<br>')}</div>
        <div class="row" style="margin-top:6px">
          <button class="btn-sm btn-ghost">Send link</button>
          <button class="btn-sm btn-danger">Cancel</button>
        </div>
      </div>`;
    }).join('');
  }

  // UI events
  document.getElementById('ordersFilter').addEventListener('change', renderAll);
  document.getElementById('salesRange').addEventListener('change', renderAll);
  document.getElementById('btnRefresh').addEventListener('click', fetchOrders);

  // Shop toggle (same compact size as Refresh)
  const shopToggle = document.getElementById('shopToggle');
  async function setShop(open){
    try{ await fetch('/api/admin/shop', { method:'POST', headers:authHeaders(), body:JSON.stringify({ open }) }); }
    catch(e){ console.warn('toggle shop failed', e); }
  }
  function flip(){
    shopToggle.classList.toggle('on');
    const on = shopToggle.classList.contains('on');
    shopToggle.setAttribute('aria-checked', on ? 'true':'false');
    setShop(on);
  }
  shopToggle.addEventListener('click', flip);
  shopToggle.addEventListener('keydown', e => { if(e.key==='Enter'||e.key===' ') { e.preventDefault(); flip(); } });

  // Start
  fetchOrders();
</script>
</body>
</html>
