<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YeloðŸŸ¡Spot â€” Admin</title>
<style>
:root{
  --bg:#0f1115;
  --panel:#161a21;
  --panel-2:#1b2029;
  --border:#212735;
  --muted:#8b93a7;
  --text:#e9edf5;
  --brand:#ffd54d;
  --accent:#ffc400;
  --success:#18c37e;
  --warning:#edb64f;
  --danger:#ff5c6c;
  --ctrl-h:32px;
  --radius:12px;
  --radius-sm:10px;
  --gap:12px;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.bar{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.9);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.05)}
.bar__row{max-width:960px;margin:0 auto;padding:6px 14px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:10px}
.brand__dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff6a3 0%,#ffd54d 50%,#b78b00 100%)}
.brand__title{font-weight:900;font-size:24px;letter-spacing:.2px}
.brand__subtitle{color:var(--muted);font-size:11px;margin-left:4px}
.controls{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.switch,.btn{height:var(--ctrl-h);display:flex;align-items:center;gap:8px;padding:0 12px;border-radius:var(--radius-sm);font-weight:800}
.switch{background:var(--panel-2);border:1px solid var(--border)}
.toggle{width:40px;height:22px;border-radius:20px;background:#2a2f3a;position:relative;transition:.2s}
.toggle:before{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}
.toggle.on{background:#1f5f3e}
.toggle.on:before{transform:translateX(20px);background:#34d399}
.btn{background:linear-gradient(180deg,#ffd86b,#ffc400);color:#242400;border:none;cursor:pointer;font-size:12px;box-shadow:0 2px 4px rgba(0,0,0,.3)}
.section{max-width:960px;margin:10px auto;padding:0 14px}
.metrics{display:flex;gap:var(--gap);flex-wrap:nowrap;justify-content:space-between;align-items:stretch}
.metric{flex:1;background:var(--panel-2);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;min-width:0;box-shadow:0 4px 12px rgba(0,0,0,.4)}
.metric__head{display:flex;justify-content:space-between;align-items:center}
.metric__title{font-weight:800;font-size:16px}
.value{font-size:26px;font-weight:900;margin-top:2px}
.select{appearance:none;background:#232938;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:5px 8px;font-size:13px;font-weight:700}
.h2{font-weight:800;margin:16px 0 10px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:12px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
.badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;font-weight:800;font-size:12px}
.badge--ok{background:#0f2a23;color:#b0ffda}
.badge--warn{background:#2a2413;color:#ffe0a6}
.badge--muted{background:#1f2430;color:#9aa3b7}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between}
.btn--small{padding:6px 10px;border-radius:8px;font-weight:700;font-size:12px;cursor:pointer;border:none}
.btn--ghost{background:#232938;color:var(--text)}
.btn--danger{background:#ff5c6c;color:#fff}
@media(max-width:480px){.metrics{flex-direction:column}}
</style>
</head>
<body>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<header class="bar">
  <div class="bar__row">
    <div class="brand">
      <span class="brand__dot"></span>
      <div>
        <div class="brand__title">YeloðŸŸ¡Spot</div>
        <div class="brand__subtitle">Admin dashboard</div>
      </div>
    </div>
    <div class="controls">
      <div class="switch"><label>Shop</label><div id="shopToggle" class="toggle"></div></div>
      <button id="btnRefresh" class="btn">âŸ³ Refresh</button>
    </div>
  </div>
</header>

<section class="section">
  <div class="metrics">
    <div class="metric">
      <div class="metric__head">
        <div class="metric__title">Orders</div>
        <select id="ordersFilter" class="select">
          <option value="all">All</option>
          <option value="confirmed">Confirmed</option>
          <option value="out">Out for delivery</option>
          <option value="delivered">Delivered</option>
          <option value="canceled">Canceled</option>
        </select>
      </div>
      <div class="value" id="ordersCount">0</div>
    </div>
    <div class="metric">
      <div class="metric__head">
        <div class="metric__title">Sales</div>
        <select id="salesRange" class="select">
          <option value="today">Today</option>
          <option value="week">This week</option>
          <option value="month">This month</option>
          <option value="all">All time</option>
        </select>
      </div>
      <div class="value">â‚±<span id="salesValue">0</span></div>
    </div>
  </div>

  <h2 class="h2">All orders</h2>
  <div id="ordersList"></div>
</section>

<script>
const tg = window.Telegram?.WebApp; tg?.ready?.(); tg?.expand?.();
const authHeaders=()=>({'X-Telegram-Init-Data':tg?.initData||'', 'Content-Type':'application/json'});
let ORDERS=[];
async function fetchOrders(){
 try{const r=await fetch('/api/admin/orders',{headers:authHeaders()});
 const j=await r.json(); if(!j.ok) throw 0; ORDERS=j.orders||[]; renderAll();}
 catch(e){console.error(e); document.getElementById('ordersList').innerHTML='<div>No orders</div>';}}
function fmtPeso(n){return Math.round(n).toLocaleString('en-PH');}
function orderKey(s){if(s===-1)return'canceled';if(s===1)return'out';if(s===2)return'delivered';return'confirmed';}
function saleAmount(items){let sum=0;for(const i of(items||[])){const m=(i.amount||'').match(/â‚±\s*([\d,]+)/);if(m)sum+=+m[1].replace(/,/g,'');}return sum;}
function insideRange(dISO,r){const t=new Date(dISO),n=new Date();if(r==='today'){const a=new Date(n.getFullYear(),n.getMonth(),n.getDate());const b=new Date(a);b.setDate(a.getDate()+1);return t>=a&&t<b;}if(r==='week'){const a=new Date(n);a.setDate(n.getDate()-n.getDay());a.setHours(0,0,0,0);const b=new Date(a);b.setDate(a.getDate()+7);return t>=a&&t<b;}if(r==='month'){const a=new Date(n.getFullYear(),n.getMonth(),1);const b=new Date(n.getFullYear(),n.getMonth()+1,1);return t>=a&&t<b;}return!0;}
function renderAll(){const f=document.getElementById('ordersFilter').value;const s=document.getElementById('salesRange').value;
const list=ORDERS.filter(o=>f==='all'||orderKey(o.statusStage)===f);document.getElementById('ordersCount').textContent=list.length;
const sales=ORDERS.filter(o=>orderKey(o.statusStage)==='delivered'&&insideRange(o.createdAt,s))
.reduce((a,o)=>a+saleAmount(o.items),0);document.getElementById('salesValue').textContent=fmtPeso(sales);
const wrap=document.getElementById('ordersList');
wrap.innerHTML=list.map(o=>`
<div class="card">
 <div class="row">
   <span class="badge badge--muted">#${o.id}</span>
   <span class="badge ${orderKey(o.statusStage)==='delivered'?'badge--ok':orderKey(o.statusStage)==='out'?'badge--warn':'badge--muted'}">
     ${orderKey(o.statusStage).replace('_',' ')}
   </span>
   <span class="badge">${new Date(o.createdAt).toLocaleString()}</span>
 </div>
 <div style="font-weight:800;font-size:16px;margin:6px 0">${o.name||'Customer'} â€¢ ${o.phone||''}</div>
 <div style="color:var(--muted)">${o.address||''}</div>
 <div style="margin:6px 0">${(o.items||[]).map(i=>`â€¢ ${i.category} â€” ${i.amount}`).join('<br>')}</div>
 <div class="row">
   <button class="btn--small btn--ghost">Send link</button>
   <button class="btn--small btn--danger">Cancel</button>
 </div>
</div>`).join('');
}
document.getElementById('ordersFilter').onchange=renderAll;
document.getElementById('salesRange').onchange=renderAll;
document.getElementById('btnRefresh').onclick=fetchOrders;
document.getElementById('shopToggle').onclick=e=>{
 e.target.classList.toggle('on');
 fetch('/api/admin/shop',{method:'POST',headers:authHeaders(),body:JSON.stringify({open:e.target.classList.contains('on')})});
};
fetchOrders();
</script>
</body>
</html>
