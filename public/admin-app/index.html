<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1"
/>
<title>YeloðŸŸ¡Spot â€” Admin Dashboard</title>
<style>
  :root{
    --bg:#0b0e11;
    --panel:#12161b;
    --panel-2:#151a20;
    --on:#e7f9ee;
    --muted:#94a3b8;
    --accent:#ffd54a;
    --ok:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;
    --ring:rgba(255,213,74,0.25);
    --glass:rgba(255,255,255,0.06);
    --glass-2:rgba(255,255,255,0.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 20% -10%, rgba(255,213,74,.12), transparent 70%), var(--bg);
    color:#e5e7eb;
  }

  .wrap{max-width:960px;margin:0 auto;padding:14px 14px 32px}

  /* Header */
  .head{
    display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:10px
  }
  .id-left{display:flex;align-items:center;gap:10px}
  .brand{
    display:flex;align-items:center;gap:8px;font-weight:700;font-size:18px
  }
  .dot{width:14px;height:14px;background:var(--accent);border-radius:50%}
  .sub{color:var(--muted);font-weight:600}
  .stamp{color:var(--muted);font-size:12px}

  .right-actions{display:flex;align-items:center;gap:10px}

  .toggle{
    display:inline-flex;align-items:center;gap:8px;
    background:var(--panel-2);border:1px solid rgba(255,255,255,.06);
    padding:8px 10px;border-radius:999px
  }
  .toggle input{appearance:none;width:36px;height:22px;border-radius:999px;background:#242a31;position:relative;outline:none;cursor:pointer}
  .toggle input:checked{background:#2e7d32}
  .toggle input::after{
    content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;
    background:#fff;transition:transform .18s ease
  }
  .toggle input:checked::after{transform:translateX(14px)}

  .btn{
    background:linear-gradient(180deg, var(--accent), #ffc72a);
    color:#1a1a1a;font-weight:700;border:none;padding:9px 14px;border-radius:14px;
    box-shadow:0 0 0 3px var(--ring) inset;cursor:pointer
  }
  .btn:active{transform:translateY(1px)}

  /* Row of two KPI cards */
  .kpis{
    display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:8px 0 16px
  }
  .card{
    background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid rgba(255,255,255,.06);
    border-radius:16px;padding:14px 14px 16px;
    box-shadow:0 8px 24px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.02)
  }
  .card h3{margin:0 0 10px 0;font-size:14px;color:var(--muted);display:flex;align-items:center;gap:10px;justify-content:space-between}
  .big{font-size:30px;font-weight:800;letter-spacing:.5px}
  .pill{
    background:var(--glass);border:1px solid rgba(255,255,255,.06);
    color:#cbd5e1;padding:6px 10px;border-radius:12px;font-size:13px
  }
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  select.select{
    background:var(--panel-2);color:#e5e7eb;border:1px solid rgba(255,255,255,.1);
    padding:6px 10px;border-radius:10px;appearance:none
  }

  /* Orders list */
  .list-title{color:var(--muted);font-weight:600;margin:4px 0 10px 4px}
  .order{
    background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px;margin-bottom:12px;
  }
  .o-top{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .oid{background:var(--glass-2);border:1px solid rgba(255,255,255,.08);padding:4px 8px;border-radius:10px;font-weight:700}
  .status-badge{padding:4px 8px;border-radius:10px;font-weight:700}
  .s-prep{background:rgba(148,163,184,.12);color:#cbd5e1;border:1px solid rgba(148,163,184,.25)}
  .s-ofd{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.25)}
  .s-done{background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25)}
  .s-cancel{background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(239,68,68,.25)}
  .who{font-weight:800;font-size:15px;margin:8px 0 2px}
  .addr{color:#cbd5e1}
  .items{margin-top:8px;color:#cbd5e1}
  .controls{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
  .btn-ghost{background:var(--panel-2);border:1px solid rgba(255,255,255,.1);color:#e5e7eb;padding:8px 12px;border-radius:12px}
  .btn-danger{background:#3b1111;border:1px solid rgba(239,68,68,.45);color:#fecaca}

  .empty{color:var(--muted);text-align:center;margin-top:20px}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="id-left">
      <div class="brand"><span class="dot"></span><span>YeloðŸŸ¡Spot</span></div>
      <div class="sub">â€” Admin Dashboard</div>
    </div>
    <div class="right-actions">
      <label class="toggle" title="Shop Open / Closed">
        <span id="shopLabel">Shop</span>
        <input id="shopToggle" type="checkbox" />
      </label>
      <button id="refreshBtn" class="btn">âŸ³ Refresh</button>
    </div>
  </div>

  <div class="stamp" id="lastUpdated">Last updated â€”</div>

  <div class="kpis">
    <!-- Orders card -->
    <div class="card">
      <h3>
        <span class="row">
          <span>Orders</span>
          <select id="ordersFilter" class="select">
            <option value="all">All</option>
            <option value="confirmed">Order Confirmed</option>
            <option value="ofd">Out for Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="canceled">Canceled</option>
          </select>
        </span>
        <span class="pill" id="ordersCount">0</span>
      </h3>
      <div class="big" id="ordersBig">0</div>
    </div>

    <!-- Sales card -->
    <div class="card">
      <h3>
        <span>Sales</span>
        <select id="salesRange" class="select">
          <option value="all">All</option>
          <option value="today">Today</option>
          <option value="week">This week</option>
          <option value="month">This month</option>
        </select>
      </h3>
      <div class="big" id="salesBig">â‚±0</div>
    </div>
  </div>

  <div class="list-title" id="listTitle">All orders</div>
  <div id="ordersList"></div>
  <div class="empty" id="emptyMsg" style="display:none;">No orders yet.</div>
</div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); tg.MainButton.hide(); }

  const state = {
    allOrders: [],
    filter: 'all',
    salesRange: 'all',
    shopOpen: true
  };

  const els = {
    lastUpdated: document.getElementById('lastUpdated'),
    refreshBtn: document.getElementById('refreshBtn'),
    ordersFilter: document.getElementById('ordersFilter'),
    salesRange: document.getElementById('salesRange'),
    ordersCount: document.getElementById('ordersCount'),
    ordersBig: document.getElementById('ordersBig'),
    salesBig: document.getElementById('salesBig'),
    ordersList: document.getElementById('ordersList'),
    emptyMsg: document.getElementById('emptyMsg'),
    listTitle: document.getElementById('listTitle'),
    shopToggle: document.getElementById('shopToggle'),
    shopLabel: document.getElementById('shopLabel')
  };

  function fmtMoney(n){ return 'â‚±' + (Math.round(n)).toLocaleString('en-PH'); }
  function ts(){ const d=new Date(); return d.toLocaleString(); }

  function authHeaders(){
    return { 'X-Telegram-Init-Data': tg?.initData || '', 'Content-Type': 'application/json' };
  }

  async function loadShop(){
    try{
      const r = await fetch('/api/admin/shop', { headers: authHeaders() });
      const j = await r.json();
      if(!j?.ok) throw new Error('shop fail');
      state.shopOpen = !!j.open;
      els.shopToggle.checked = state.shopOpen;
      els.shopLabel.textContent = state.shopOpen ? 'Open' : 'Closed';
    }catch(e){
      console.warn('Shop fetch failed', e);
    }
  }
  async function toggleShop(open){
    try{
      const r = await fetch('/api/admin/shop', {
        method:'POST',
        headers: authHeaders(),
        body: JSON.stringify({ open })
      });
      const j = await r.json();
      if(!j?.ok) throw new Error('toggle failed');
      state.shopOpen = !!j.open;
      els.shopLabel.textContent = state.shopOpen ? 'Open' : 'Closed';
    }catch(e){
      alert('Failed to toggle shop.');
      els.shopToggle.checked = !open; // revert UI
    }
  }

  function priceFromLabel(label){
    // Extract the peso at start like "â‚±1,000 â€” 0.056" or "â‚±700 â€¢ Brand"
    const m = label.match(/â‚±\s*([\d,]+)/);
    return m ? Number(m[1].replace(/,/g,'')) : 0;
    // If you want grams/units to affect price, compute here differently.
  }

  function salesSum(orders){
    // Sum only completed (delivered) orders for "Sales"
    const delivered = orders.filter(o => (o.status==='completed'||o.statusStage===2));
    return delivered.reduce((sum,o)=>{
      const line = (Array.isArray(o.items)?o.items:[]).reduce((s,it)=> s + priceFromLabel(it.amount||''), 0);
      return sum + line;
    },0);
  }

  function filterOrders(){
    let arr = [...state.allOrders];
    switch(state.filter){
      case 'confirmed': arr = arr.filter(o => o.status==='paid' || o.statusStage===0); break;
      case 'ofd':       arr = arr.filter(o => o.status==='out_for_delivery' || o.statusStage===1); break;
      case 'delivered': arr = arr.filter(o => o.status==='completed' || o.statusStage===2); break;
      case 'canceled':  arr = arr.filter(o => o.status==='canceled' || o.statusStage===-1); break;
      default:          /* all */ break;
    }
    return arr;
  }

  function applySalesWindow(orders){
    const now = new Date();
    const start = new Date(0);
    const range = state.salesRange;
    if(range==='today'){
      start.setTime(new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime());
    } else if(range==='week'){
      const day = now.getDay(); // 0 Sun
      const diff = (day+6)%7;   // monday start
      start.setTime(new Date(now.getFullYear(), now.getMonth(), now.getDate()-diff).getTime());
    } else if(range==='month'){
      start.setTime(new Date(now.getFullYear(), now.getMonth(), 1).getTime());
    }
    return orders.filter(o => new Date(o.createdAt||o.created_at||o.updatedAt) >= start);
  }

  function statusBadge(o){
    if (o.status==='canceled' || o.statusStage===-1) return '<span class="status-badge s-cancel">Canceled</span>';
    if (o.status==='completed' || o.statusStage===2) return '<span class="status-badge s-done">Delivered</span>';
    if (o.status==='out_for_delivery' || o.statusStage===1) return '<span class="status-badge s-ofd">Out for Delivery</span>';
    return '<span class="status-badge s-prep">Confirmed</span>';
  }

  function render(){
    const filtered = filterOrders();
    const salesPool = applySalesWindow(state.allOrders);
    els.ordersCount.textContent = String(filtered.length);
    els.ordersBig.textContent = String(filtered.length);
    els.salesBig.textContent = fmtMoney(salesSum(salesPool));
    const titles = { all:'All orders', confirmed:'Confirmed orders', ofd:'Out for Delivery', delivered:'Delivered', canceled:'Canceled' };
    els.listTitle.textContent = titles[state.filter] || 'All orders';

    els.ordersList.innerHTML = '';
    if (!filtered.length){ els.emptyMsg.style.display='block'; return; }
    els.emptyMsg.style.display='none';

    filtered.forEach(o=>{
      const itemsText = (Array.isArray(o.items)?o.items:[]).map(it=>'â€¢ '+(it.category||'item')+' â€” '+(it.amount||'')).join('<br>');
      const ts = new Date(o.createdAt || o.created_at).toLocaleString();
      const addr = o.address || '';
      const who = (o.name || 'Customer') + (o.phone ? ' â€¢ ' + o.phone : '');
      const badge = statusBadge(o);

      const row = document.createElement('div');
      row.className='order';
      row.innerHTML = `
        <div class="o-top">
          <span class="oid">#${o.id}</span>
          <span class="stamp">Received: ${ts}</span>
          ${badge}
        </div>
        <div class="who">${who}</div>
        <div class="addr">${addr}</div>
        <div class="items" style="margin-top:10px">${itemsText || ''}</div>
        <div class="controls">
          <button class="btn-ghost" data-act="send" data-id="${o.id}">Send link</button>
          <select class="select" data-act="stage" data-id="${o.id}">
            <option value="0" ${(o.statusStage===0||o.status==='paid')?'selected':''}>Order confirmed</option>
            <option value="1" ${(o.statusStage===1||o.status==='out_for_delivery')?'selected':''}>Out for delivery</option>
            <option value="2" ${(o.statusStage===2||o.status==='completed')?'selected':''}>Delivered</option>
            <option value="-1" ${(o.statusStage===-1||o.status==='canceled')?'selected':''}>Canceled</option>
          </select>
          <button class="btn-ghost btn-danger" data-act="cancel" data-id="${o.id}">Cancel</button>
        </div>
      `;
      els.ordersList.appendChild(row);
    });
  }

  async function loadOrders(){
    try{
      const r = await fetch('/api/admin/orders', { headers: authHeaders() });
      const j = await r.json();
      if(!j?.ok) throw new Error('auth/db');
      state.allOrders = j.orders || [];
      els.lastUpdated.textContent = 'Last updated â€¢ ' + ts();
      render();
    }catch(e){
      console.error(e);
      alert('YeloðŸŸ¡Spot\n\nAuth/DB error loading orders');
    }
  }

  async function setStage(id, stage){
    const r = await fetch(`/api/admin/orders/${id}/stage`, {
      method:'POST',
      headers: authHeaders(),
      body: JSON.stringify({ stage:Number(stage) })
    });
    const j = await r.json();
    if(!j?.ok) throw new Error('stage fail');
  }

  async function sendLink(id){
    const link = prompt('Paste delivery/tracking link for order #' + id);
    if(!link) return;
    const r = await fetch(`/api/admin/orders/${id}/sendlink`, {
      method:'POST', headers: authHeaders(), body: JSON.stringify({ link })
    });
    const j = await r.json();
    if(!j?.ok) throw new Error('sendlink fail');
    await loadOrders();
  }

  // Events
  els.refreshBtn.addEventListener('click', loadOrders);
  els.ordersFilter.addEventListener('change', e=>{ state.filter = e.target.value; render(); });
  els.salesRange.addEventListener('change', e=>{ state.salesRange = e.target.value; render(); });

  els.ordersList.addEventListener('change', async (e)=>{
    const sel = e.target.closest('select[data-act="stage"]');
    if(!sel) return;
    const id = sel.getAttribute('data-id');
    const stage = sel.value;
    try{ await setStage(id, stage); await loadOrders(); }
    catch{ alert('Failed to update status.'); }
  });
  els.ordersList.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const id = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    if(act==='send'){ await sendLink(id); }
    if(act==='cancel'){
      if(confirm('Cancel order #' + id + '?')){
        try{ await setStage(id, -1); await loadOrders(); }
        catch{ alert('Failed to cancel.'); }
      }
    }
  });

  // Shop toggle
  els.shopToggle.addEventListener('change', (e)=>{
    toggleShop(e.target.checked);
  });

  // Init
  (async function(){
    await loadShop();
    await loadOrders();
    // auto refresh every 25s
    setInterval(loadOrders, 25000);
  })();
</script>
</body>
</html>
