<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>YeloðŸŸ¡Spot â€” Admin</title>
<style>
  :root{
    --bg:#0a0f15; --panel:#0f1520; --soft:#101826; --line:#1f2a3a;
    --text:#e8eef7; --muted:#9aa6b2; --brand:#ffd400;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --accent:#273249;
    --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0b1422 70%);
    color:var(--text); font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .app{max-width:920px;margin:0 auto;padding:16px 14px 60px}
  .topbar{display:flex;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px}
  .brand .dot{width:18px;height:18px;border-radius:50%;background:var(--brand)}
  .spacer{flex:1}
  .switch{
    display:inline-flex;align-items:center;background:#0e1726;border:1px solid var(--line);
    padding:4px 8px;border-radius:999px;gap:10px
  }
  .switch input{appearance:none;width:44px;height:24px;background:#1c2535;border-radius:999px;position:relative;outline:none;border:1px solid #2a364c;cursor:pointer}
  .switch input:checked{background:#163221;border-color:#1f6f41}
  .switch input:before{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:#cfd7e6;border-radius:50%;transition:transform .18s}
  .switch input:checked:before{transform:translateX(20px);background:#7fffb4}
  .btn{background:#1a2333;border:1px solid #2a364c;color:#dbe2ea;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn.small{padding:8px 12px;border-radius:10px}
  .btn.yellow{background:#2b210b;border-color:#5a4413;color:#ffd97a}

  /* ---- SUMMARY TILES (âˆ’20% height) ---- */
  .summary{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0 4px}
  .tile{background:linear-gradient(180deg,#0f1520,#0b121d);border:1px solid var(--line);
        border-radius:14px;padding:11px 12px;box-shadow:var(--shadow)}
  .tile h4{
    margin:0;color:#b8c6d8;font-weight:800;font-size:12px;
    display:flex;align-items:center;gap:8px
  }
  .tile .row{margin-top:6px}
  .big{font-size:22px;font-weight:800} /* was 26px */

  /* compact inline filter */
  .filter{
    appearance:none;background:#121b2a;border:1px solid #2a364c;color:#cfd7e6;
    font-size:12px; padding:4px 22px 4px 8px; border-radius:10px;
    line-height:1; height:26px; margin-left:auto
  }

  .muted{color:#9aa6b2}
  .section-title{font-weight:800;font-size:18px;margin:16px 0 10px}

  .card{
    background:linear-gradient(180deg,var(--panel),var(--soft)); border:1px solid var(--line);
    border-radius:var(--radius); box-shadow:var(--shadow); padding:14px;
    margin:12px 0;
  }
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .idpill{background:#0d1626;border:1px solid var(--line);padding:5px 10px;border-radius:999px;color:#a7b5c7;font-weight:700}
  .when{background:#0d1626;border:1px solid var(--line);color:#a7b5c7;border-radius:999px;padding:5px 10px}
  .title{font-weight:900;font-size:18px;margin:10px 0 6px 0}
  .list{padding-left:18px;margin:6px 0;color:#dbe3ee}
  .list li{margin:2px 0}
  .card-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn.red{background:#2b1417;border-color:#5a1e25;color:#ffc9c9}

  /* chat in card (shrink message area ~20%) */
  .chat{background:#0b111b;border:1px solid var(--line);border-radius:12px;padding:10px;margin-top:10px}
  .msg-list{display:flex;flex-direction:column;gap:10px;min-height:64px;max-height:160px;overflow:auto;padding-right:6px}
  .msg{display:flex}
  .msg .bub{max-width:85%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);white-space:pre-wrap}
  .msg.customer{justify-content:flex-start}
  .msg.customer .bub{background:#141c28}
  .msg.admin{justify-content:flex-end}
  .msg.admin .bub{background:#10213a}
  .msgmeta{font-size:11px;color:#9aa6b2;margin-bottom:4px}
  .chat-entry{display:flex;gap:8px;margin-top:8px}
  .chat-entry textarea{flex:1;min-height:40px;resize:vertical;background:#0e1523;border:1px solid #1f2937;border-radius:10px;color:var(--text);padding:10px}
  .empty{color:var(--muted)}

  .unauth{background:#1b1210;border:1px solid #3e2a24;color:#ffd6b5;padding:12px;border-radius:12px;margin:10px 0}

  /* messenger-style icon button */
  .icon-btn{
    display:inline-flex;align-items:center;justify-content:center;
    width:34px;height:34px;border-radius:10px;border:1px solid #2a364c;background:#1a2333;cursor:pointer;
  }
  .icon-btn svg{width:18px;height:18px;display:block;opacity:.9}
</style>
</head>
<body>
  <div class="app">
    <!-- header -->
    <div class="topbar">
      <div class="brand">Yelo<span class="dot"></span>Spot</div>
      <div class="spacer"></div>
      <label class="switch">
        <span class="muted">Shop</span>
        <input id="shopToggle" type="checkbox" />
      </label>
      <button id="btnRefresh" class="btn yellow">âŸ³ Refresh</button>
    </div>

    <!-- summary -->
    <div class="summary">
      <div class="tile">
        <h4>
          Orders
          <select id="ordersRange" class="filter">
            <option value="all">All</option>
            <option value="confirmed">Order confirmed</option>
            <option value="out_for_delivery">Out for delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </h4>
        <div class="row">
          <div id="ordersCount" class="big">0</div>
        </div>
      </div>

      <div class="tile">
        <h4>
          Sales
          <select id="salesRange" class="filter">
            <option value="today">Today</option>
            <option value="week">Week</option>
            <option value="month">Month</option>
            <option value="all">All</option>
          </select>
        </h4>
        <div class="row">
          <div class="big">â‚±<span id="salesTotal">0</span></div>
        </div>
      </div>
    </div>

    <div id="unauth" class="unauth" style="display:none">
      <b>Unauthorized:</b> Please open inside Telegram (Admin WebApp).
    </div>

    <div class="section-title">All orders</div>
    <div id="cards"></div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    /* ---------------- Telegram WebApp auth ---------------- */
    const tg = window.Telegram?.WebApp;
    let initData = "";
    let insideTG = false;

    if (tg && tg.initData) { insideTG = true; initData = tg.initData; tg.ready(); tg.expand && tg.expand(); }
    else { const qp = new URLSearchParams(location.search); initData = qp.get("initData") || ""; insideTG = !!initData; }
    document.getElementById("unauth").style.display = insideTG ? "none" : "block";

    /* ---------------- small helpers ---------------- */
    const $  = (s)=>document.querySelector(s);
    const $$ = (s)=>document.querySelectorAll(s);
    const cards = $("#cards");
    const shopToggle = $("#shopToggle");
    const btnRefresh = $("#btnRefresh");
    const peso = (n)=> new Intl.NumberFormat("en-PH").format(n||0);
    const fmt = (iso)=> { try{ return new Date(iso).toLocaleString(); }catch{ return iso||"-"; } };
    const api = async (path, method="GET", body) => {
      const res = await fetch(path, {
        method,
        headers:{ "Content-Type":"application/json","X-Telegram-Init-Data": initData },
        body: body? JSON.stringify(body): undefined
      });
      const j = await res.json().catch(()=>({}));
      if (!j?.ok) throw new Error(j?.error || "api_error");
      return j;
    };
    const esc = (s)=> (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    /* ---------------- filters + date helpers ---------------- */
    let ORDER_FILTER = "all";     // all | confirmed | out_for_delivery | delivered | cancelled
    let SALES_RANGE  = "today";   // today | week | month | all

    const asDate = (d)=> (d instanceof Date ? d : new Date(d));

    function inRange(dt, range){
      const now = new Date();
      if (range === "all") return true;
      if (range === "today"){
        const a = new Date(now); a.setHours(0,0,0,0);
        const b = new Date(now); b.setHours(23,59,59,999);
        return dt >= a && dt <= b;
      }
      if (range === "week"){
        const day = (now.getDay()+6)%7; // Monday start
        const a = new Date(now); a.setDate(now.getDate()-day); a.setHours(0,0,0,0);
        const b = new Date(a);  b.setDate(a.getDate()+7); b.setMilliseconds(-1);
        return dt >= a && dt <= b;
      }
      if (range === "month"){
        const a = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
        const b = new Date(now.getFullYear(), now.getMonth()+1, 0, 23,59,59,999);
        return dt >= a && dt <= b;
      }
      return true;
    }

    // Normalize to one of our filterable statuses
    function normalizeStatus(o){
      const txt = (o.statusText || o.status || "").toString().toLowerCase();
      const stg = Number(o.statusStage);
      if (stg === 2 || txt.includes("delivered")) return "delivered";
      if (stg === -1 || txt.includes("cancel")) return "cancelled";
      if (txt.includes("out") && txt.includes("delivery")) return "out_for_delivery";
      if (stg === 1 || txt.includes("confirm")) return "confirmed";
      return "confirmed"; // default after creation
    }

    /* ---------------- state ---------------- */
    let ORDERS_ALL = [];       // raw from API, normalized
    const POLL = new Map();    // orderId -> intervalId

    /* ---------------- render helpers ---------------- */
    function itemsList(items){
      if (!items?.length) return "";
      return `<ul class="list">${items.map(i=>`<li>${esc(i.category)} â€” ${esc(i.amount)}`).join("")}</ul>`;
    }

    function cardHtml(o){
      const isDelivered = normalizeStatus(o) === "delivered";
      return `
      <div class="card" data-id="${o.id}">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <div class="idpill">#${o.id}</div>
            <div class="when">${fmt(o.createdAt)}</div>
          </div>
        </div>

        <div class="title">${esc(o.name || "â€”")} â€¢ ${esc(o.phone || o.customerChatId || "")}</div>
        <div class="muted" style="margin-bottom:6px">${esc(o.address || "")}</div>

        ${itemsList(o.items)}

        ${isDelivered ? `
          <div class="row" style="align-items:flex-start; gap:12px; margin-top:10px">
            <div style="width:36px;height:36px;border-radius:50%;border:2px solid #1e9b57;display:flex;align-items:center;justify-content:center;color:#86f7b9">âœ“</div>
            <div>
              <div style="font-weight:800">Delivered</div>
              <div class="muted">This order is complete. Actions are disabled.</div>
            </div>
          </div>` : ""}

        <div class="card-actions">
          ${isDelivered ? "" : `
            <button class="btn small" data-act="sendlink">Send link</button>
            <button class="btn small" data-act="stage1">Order confirmed</button>
            <button class="btn small red" data-act="cancel">Cancel</button>
          `}
          <button class="icon-btn" data-act="toggle-chat" title="Chat">
            <!-- messenger-like bubble with lightning -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 11.5c0 4.418-4.03 8-9 8-1.15 0-2.25-.18-3.25-.52L3 20l1.2-3.3C3.44 15.3 3 13.93 3 12.5 3 8.08 7.03 5 12 5s9 3.08 9 6.5Z"/>
              <path d="M10 12l3-3-1 3 2 2-3 1 1-3-2-2Z"/>
            </svg>
          </button>
        </div>

        <div class="chat" id="chat-${o.id}" style="display:none">
          <div class="msg-list" id="msgs-${o.id}"><div class="empty">No messages yet.</div></div>
          <div class="chat-entry">
            <textarea id="input-${o.id}" placeholder="Type a message to customerâ€¦"></textarea>
            <button class="btn" data-act="sendmsg">Send</button>
          </div>
        </div>
      </div>`;
    }

    /* ---------- DERIVED DATA (filters!) ---------- */
    function filteredOrders(){
      return ORDERS_ALL.filter(o => {
        const st = normalizeStatus(o);
        return ORDER_FILTER === "all" ? true : st === ORDER_FILTER;
      });
    }

    function parseOrderTotalPHP(order){
      const items = order.items || [];
      let t = 0;
      items.forEach(it=>{
        const m = /â‚±\s*([\d,]+)/.exec(String(it.amount));
        if (m) t += Number(m[1].replace(/,/g,"")) || 0;
        else if ((it.category||"").startsWith("poppers")) t += 700; // your original fallback
      });
      return t;
    }

    function salesTotal(){
      // only delivered orders count as sales
      return ORDERS_ALL
        .filter(o => normalizeStatus(o) === "delivered")
        .filter(o => inRange(asDate(o.createdAt), SALES_RANGE))
        .reduce((sum, o) => sum + parseOrderTotalPHP(o), 0);
    }

    /* ---------------- render ---------------- */
    function render(){
      const list = filteredOrders().sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
      cards.innerHTML = list.map(cardHtml).join("") || `<div class="muted">No orders for this filter.</div>`;

      // summary numbers (use DERIVED arrays!)
      $("#ordersCount").textContent = String(list.length);
      $("#salesTotal").textContent  = peso(salesTotal());
    }

    /* ---------------- load data ---------------- */
    async function loadShop(){
      try{ const j = await api("/api/admin/shop"); shopToggle.checked = !!j.open; }catch{}
    }
    async function loadOrders(){
      try{
        const j = await api("/api/admin/orders");
        ORDERS_ALL = (j.orders || []).map(o => ({
          ...o,
          createdAt: asDate(o.createdAt)
        }));
        render();
      }catch(e){ console.error(e); }
    }

    /* ---------------- chat ---------------- */
    async function loadMessages(orderId){
      const box = document.getElementById(`msgs-${orderId}`);
      try{
        const j = await api(`/api/admin/orders/${orderId}/messages`);
        const msgs = j.messages || [];
        if (!msgs.length){ box.innerHTML = '<div class="empty">No messages yet.</div>'; return; }
        box.innerHTML = msgs.map(m=>{
          const who = m.sender === 'admin' ? 'admin' : 'customer';
          const when = fmt(m.created_at || m.createdAt);
          return `<div class="msg ${who}">
                    <div class="bub">
                      <div class="msgmeta">${who === 'admin' ? 'Admin' : 'Customer'} â€¢ ${when}</div>
                      ${esc(m.message || '')}
                    </div>
                  </div>`;
        }).join("");
        box.scrollTop = box.scrollHeight;
      }catch{ box.innerHTML = '<div class="empty">Failed to load messages.</div>'; }
    }
    function startPolling(orderId){ stopPolling(orderId); const id = setInterval(()=>loadMessages(orderId), 5000); POLL.set(orderId, id); }
    function stopPolling(orderId){ const id = POLL.get(orderId); if (id){ clearInterval(id); POLL.delete(orderId); } }

    /* ---------------- events ---------------- */
    shopToggle.addEventListener("change", async ()=>{
      try{ await api("/api/admin/shop","POST",{ open: shopToggle.checked }); }
      catch{ shopToggle.checked = !shopToggle.checked; }
    });
    btnRefresh.addEventListener("click", async ()=>{ await Promise.all([loadShop(), loadOrders()]); });

    cards.addEventListener("click", async (ev)=>{
      const card = ev.target.closest(".card"); if (!card) return;
      const id = Number(card.dataset.id); const act = ev.target.dataset.act || ev.target.closest("[data-act]")?.dataset.act;

      if (act === "toggle-chat"){
        const wrap = document.getElementById(`chat-${id}`);
        const show = wrap.style.display === "none";
        wrap.style.display = show ? "block" : "none";
        if (show){ await loadMessages(id); startPolling(id); } else { stopPolling(id); }
        return;
      }
      if (act === "sendmsg"){
        const ta = document.getElementById(`input-${id}`); const text = ta.value.trim(); if (!text) return;
        try{ await api(`/api/admin/orders/${id}/messages`, "POST", { message: text }); ta.value = ""; await loadMessages(id); }
        catch{ alert("Failed to send message."); }
        return;
      }
      if (act === "sendlink"){
        const link = prompt("Enter delivery/tracking link:"); if (!link) return;
        try{ await api(`/api/admin/orders/${id}/sendlink`, "POST", { link }); alert("Link sent."); await loadOrders(); }
        catch{ alert("Failed to send link."); }
        return;
      }
      if (act === "stage1"){
        try{ await api(`/api/admin/orders/${id}/stage`, "POST", { stage: 1 }); await loadOrders(); }
        catch{ alert("Failed to update stage."); }
        return;
      }
      if (act === "cancel"){
        if (!confirm("Cancel this order?")) return;
        try{ await api(`/api/admin/orders/${id}/stage`, "POST", { stage: -1 }); await loadOrders(); }
        catch{ alert("Cancel failed."); }
        return;
      }
    });

    /* filters -> re-render */
    $("#ordersRange").addEventListener("change", (e)=>{ ORDER_FILTER = e.target.value; render(); });
    $("#salesRange").addEventListener("change",  (e)=>{ SALES_RANGE  = e.target.value; render(); });

    /* ---------------- init ---------------- */
    (async function init(){ await loadShop(); await loadOrders(); })();
  </script>
</body>
</html>
