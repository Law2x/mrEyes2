<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Yeloüü°Spot ‚Äî Admin Dashboard</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#111827; --muted:#6b7280; --text:#e5e7eb; --soft:#151b26;
      --brand:#ffd400; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --line:#1f2937;
      --btn:#1f2937; --btnH:#2b3649; --pill:#0f1b12; --shadow:0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),#0d1522 70%), var(--bg);
      color:var(--text); font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      padding-bottom:32px;
    }
    .app{max-width:980px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;gap:14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px}
    .brand .dot{width:18px;height:18px;border-radius:50%;background:var(--brand);display:inline-block}
    .spacer{flex:1}
    .chip{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;
          background:var(--pill); color:#b8f6c2; border:1px solid rgba(34,197,94,.25)}
    .chip .led{width:9px;height:9px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .btn{background:var(--btn);border:1px solid #263143;color:#dbe2ea;border-radius:12px;padding:9px 12px;cursor:pointer}
    .btn:hover{background:var(--btnH)}
    .small{padding:6px 10px;border-radius:10px;font-size:13px}
    .grid{display:grid;gap:14px;margin-top:16px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .panel{background:linear-gradient(180deg,var(--panel),var(--soft)); border:1px solid var(--line);
           border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .p-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .p-title{font-weight:700}
    .p-body{padding:12px 16px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);vertical-align:top}
    th{color:#9aa6b2;font-weight:700;text-align:left}
    .badge{display:inline-block;border:1px solid #2c3a50;background:#0f172a;padding:4px 8px;border-radius:999px;font-size:12px}
    .badge.ok{border-color:#1e8f4d;color:#a6f3c3;background:#0e1b14}
    .badge.out{border-color:#3aa3ff;color:#cbe6ff;background:#0d1723}
    .badge.done{border-color:#22c55e;color:#c7f9d4;background:#0f1b12}
    .badge.cancel{border-color:#ef4444;color:#fecaca;background:#220e12}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .input, textarea{width:100%;background:#0e1523;border:1px solid #1f2937;border-radius:12px;
                     color:var(--text);padding:10px 12px}
    textarea{min-height:54px;resize:vertical}
    .chat-wrap{display:flex;flex-direction:column;gap:10px}
    .chat-sel{width:100%}
    .msg-list{background:#0a101a;border:1px solid var(--line);border-radius:12px;min-height:160px;
              padding:12px;display:flex;flex-direction:column;gap:10px}
    .msg{display:flex;gap:10px}
    .msg .bubble{max-width:86%;padding:10px 12px;border-radius:12px;border:1px solid var(--line)}
    .msg.admin{justify-content:flex-end}
    .msg.admin .bubble{background:#10213a}
    .msg.customer .bubble{background:#141c28}
    .empty{color:var(--muted);text-align:center;padding:14px}
    .row{display:flex;gap:8px;align-items:center}
    .select{appearance:none;background:#0e1523;border:1px solid #1f2937;border-radius:10px;
            color:var(--text);padding:8px 10px}
    .pill-btn{border-radius:10px}
    .help{font-size:13px;color:#9aa6b2}
    .warn{color:#fbbf24}
  </style>
</head>
<body>
  <div class="app">
    <!-- Top -->
    <div class="topbar">
      <div class="brand">Yelo<span class="dot"></span>Spot</div>
      <div class="spacer"></div>
      <div id="shopChip" class="chip"><span class="led"></span> <b>Shop:</b>&nbsp;<span id="shopState">‚Äî</span></div>
      <button id="btnRefresh" class="btn small">Refresh</button>
    </div>

    <!-- Stats (optional count placeholders) -->
    <div class="grid" style="grid-template-columns: 1fr 320px;">
      <!-- Orders -->
      <div class="panel" style="grid-column:1 / span 1">
        <div class="p-head">
          <div class="p-title">Recent Orders</div>
          <div class="row">
            <select id="timeFilter" class="select small">
              <option value="all">All</option>
              <option value="today">Today</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
            </select>
          </div>
        </div>
        <div class="p-body" id="ordersBox">
          <div class="empty" id="notTG" style="display:none">
            <b>Unauthorized:</b> Please open inside Telegram <span class="help">(Admin WebApp)</span>.
          </div>
          <div style="overflow:auto">
            <table id="ordersTable">
              <thead>
                <tr>
                  <th style="min-width:72px">Order</th>
                  <th style="min-width:120px">Created</th>
                  <th style="min-width:200px">Customer</th>
                  <th style="min-width:220px">Items</th>
                  <th>Stage</th>
                  <th style="min-width:210px">Actions</th>
                </tr>
              </thead>
              <tbody id="ordersBody">
                <tr><td colspan="6" class="empty">No data.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Chat -->
      <div class="panel" style="grid-column:2 / span 1">
        <div class="p-head">
          <div class="p-title">Chat</div>
        </div>
        <div class="p-body chat-wrap">
          <select id="orderSelect" class="select chat-sel">
            <option value="">Select an order to view messages</option>
          </select>
          <div class="msg-list" id="msgList"><div class="empty">No messages yet.</div></div>
          <div class="row">
            <textarea id="chatInput" placeholder="Type a message to customer‚Ä¶"></textarea>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button id="sendBtn" class="btn">Send</button>
          </div>
          <div class="help">Messages send from here appear to the customer as <b>‚ÄúAdmin‚Äù</b>.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // ---------- Telegram WebApp bootstrap ----------
    const tg = window.Telegram?.WebApp;
    let initData = "";
    let isInsideTelegram = false;

    if (tg && tg.initData) {
      initData = tg.initData;
      isInsideTelegram = true;
      tg.ready();
      tg.expand && tg.expand();
    } else {
      // Fallback: allow testing via ?initData=...
      const qp = new URLSearchParams(location.search);
      initData = qp.get("initData") || "";
      isInsideTelegram = !!initData;
    }

    // Show unauthorized banner if not in Telegram
    document.getElementById("notTG").style.display = isInsideTelegram ? "none" : "block";

    // ---------- Helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const ordersBody = $("#ordersBody");
    const orderSelect = $("#orderSelect");
    const msgList = $("#msgList");
    const chatInput = $("#chatInput");
    const sendBtn = $("#sendBtn");
    const shopStateEl = $("#shopState");
    const btnRefresh = $("#btnRefresh");

    async function api(path, method = "GET", body) {
      const res = await fetch(path, {
        method,
        headers: {
          "Content-Type": "application/json",
          "X-Telegram-Init-Data": initData
        },
        body: body ? JSON.stringify(body) : undefined
      });
      const j = await res.json().catch(() => ({}));
      if (!j?.ok) throw new Error(j?.error || "api_error");
      return j;
    }

    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString();
      }catch{ return iso || "-" }
    }
    function stageBadge(o){
      const s = Number(o.statusStage ?? 0);
      if (s === 2) return '<span class="badge done">Delivered</span>';
      if (s === 1) return '<span class="badge out">Out for delivery</span>';
      if (s === -1) return '<span class="badge cancel">Canceled</span>';
      return '<span class="badge">Preparing</span>';
    }
    function itemsText(items){
      if (!items || !items.length) return "‚Äî";
      return items.map(i => `${i.category} ‚Äî ${i.amount}`).join("<br>");
    }

    // ---------- Shop state ----------
    async function loadShop(){
      try{
        const j = await api("/api/admin/shop");
        shopStateEl.textContent = j.open ? "OPEN" : "CLOSED";
        const led = document.querySelector("#shopChip .led");
        led.style.background = j.open ? "#22c55e" : "#ef4444";
        document.querySelector("#shopChip").style.color = j.open ? "#b8f6c2" : "#fecaca";
        document.querySelector("#shopChip").style.borderColor = j.open ? "rgba(34,197,94,.25)" : "rgba(239,68,68,.25)";
        document.querySelector("#shopChip").style.background = j.open ? "var(--pill)" : "#1e0f11";
      }catch(e){
        shopStateEl.textContent = "‚Äî";
      }
    }

    // ---------- Orders ----------
    let ORDERS = [];
    async function loadOrders(){
      try{
        const j = await api("/api/admin/orders");
        ORDERS = j.orders || [];
        // Fill table
        ordersBody.innerHTML = "";
        if (!ORDERS.length){
          ordersBody.innerHTML = '<tr><td colspan="6" class="empty">No orders yet.</td></tr>';
        }else{
          ORDERS.forEach(o => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>#${o.id}</td>
              <td>${fmtDate(o.createdAt)}</td>
              <td>
                <div><b>${o.name || "N/A"}</b></div>
                <div class="muted">${o.phone || ""}</div>
                <div class="muted" style="max-width:280px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${o.address || ""}</div>
              </td>
              <td style="max-width:260px">${itemsText(o.items)}</td>
              <td>${stageBadge(o)}</td>
              <td class="row-actions">
                <button class="btn small pill-btn" data-act="view" data-id="${o.id}">View</button>
                <button class="btn small pill-btn" data-act="send" data-id="${o.id}">Send Link</button>
                <button class="btn small pill-btn" data-act="done" data-id="${o.id}">Done</button>
                <button class="btn small pill-btn" data-act="cancel" data-id="${o.id}">Cancel</button>
              </td>`;
            ordersBody.appendChild(tr);
          });
        }
        // Fill chat selector
        orderSelect.innerHTML = '<option value="">Select an order to view messages</option>';
        ORDERS.forEach(o=>{
          const opt = document.createElement("option");
          opt.value = String(o.id);
          opt.textContent = `#${o.id} ‚Äî ${o.name || o.phone || o.customerChatId}`;
          orderSelect.appendChild(opt);
        });
      }catch(e){
        console.error(e);
        ordersBody.innerHTML = `<tr><td colspan="6" class="empty">Unauthorized: Please open inside Telegram (Admin WebApp).</td></tr>`;
      }
    }

    ordersBody.addEventListener("click", async (ev)=>{
      const btn = ev.target.closest("button[data-act]");
      if (!btn) return;
      const id = Number(btn.dataset.id);
      const act = btn.dataset.act;

      if (act === "view"){
        orderSelect.value = String(id);
        await loadMessages(id);
        msgList.scrollTop = msgList.scrollHeight;
      }
      if (act === "send"){
        const link = prompt("Enter delivery/tracking link:");
        if (!link) return;
        try{
          await api(`/api/admin/orders/${id}/sendlink`, "POST", { link });
          alert("Link sent to customer.");
          await loadOrders();
        }catch(e){ alert("Failed to send link."); }
      }
      if (act === "done"){
        try{
          await api(`/api/admin/orders/${id}/stage`, "POST", { stage: 2 });
          await loadOrders();
        }catch(e){ alert("Failed to update stage."); }
      }
      if (act === "cancel"){
        if (!confirm("Cancel this order?")) return;
        try{
          await api(`/api/admin/orders/${id}/stage`, "POST", { stage: -1 });
          await loadOrders();
        }catch(e){ alert("Failed to update stage."); }
      }
    });

    // ---------- Chat ----------
    let currentOrderId = null;

    async function loadMessages(orderId){
      if (!orderId){ msgList.innerHTML = '<div class="empty">No messages yet.</div>'; return; }
      try{
        const j = await api(`/api/admin/orders/${orderId}/messages`);
        const msgs = j.messages || [];
        if (!msgs.length){
          msgList.innerHTML = '<div class="empty">No messages yet.</div>';
          return;
        }
        msgList.innerHTML = "";
        msgs.forEach(m=>{
          const el = document.createElement("div");
          el.className = `msg ${m.sender}`;
          el.innerHTML = `<div class="bubble">
              <div style="font-size:12px;color:#9aa6b2">${m.sender === 'admin' ? 'Admin' : 'Customer'} ‚Ä¢ ${fmtDate(m.created_at||m.createdAt)}</div>
              <div style="margin-top:4px;white-space:pre-wrap">${escapeHtml(m.message||'')}</div>
            </div>`;
          msgList.appendChild(el);
        });
        msgList.scrollTop = msgList.scrollHeight;
      }catch(e){
        msgList.innerHTML = '<div class="empty">Unable to load messages.</div>';
      }
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    orderSelect.addEventListener("change", async ()=>{
      currentOrderId = Number(orderSelect.value || 0) || null;
      await loadMessages(currentOrderId);
    });

    sendBtn.addEventListener("click", async ()=>{
      const id = Number(orderSelect.value || 0);
      const message = chatInput.value.trim();
      if (!id) { alert("Select an order first."); return; }
      if (!message) return;
      try{
        await api(`/api/admin/orders/${id}/messages`, "POST", { message });
        chatInput.value = "";
        await loadMessages(id);
      }catch(e){
        alert("Failed to send message.");
      }
    });

    // ---------- Refresh ----------
    btnRefresh.addEventListener("click", async ()=>{
      await Promise.all([loadShop(), loadOrders()]);
      if (orderSelect.value) await loadMessages(Number(orderSelect.value));
    });

    // ---------- Initial ----------
    (async function init(){
      await loadShop();
      await loadOrders();
      // Optional: auto-poll chat for selected order every 6s
      setInterval(()=>{ if (orderSelect.value) loadMessages(Number(orderSelect.value)); }, 6000);
    })();
  </script>
</body>
</html>
